/*
* System Designer
* https://system-designer.github.io
* @ecarriou
*
* Copyright 2016 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
runtime.on("ready",function(){var a=this.system("design"),b=this.require("DialogCopyright");b.on("init",function(a){var b="",c=null;$("#designer-dialog-copyright").empty(),b=this.require("dialog-modal-copyright.html"),document.querySelector("#designer-dialog-copyright").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-copyright-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),b.on("show",function(){$("#designer-dialog-copyright-modal").modal("show")}),b.on("hide",function(){$("#designer-dialog-copyright-modal").modal("hide")});var c=this.require("MenuBar");c.on("init",function(a){var b=[],c=[],d=[],e=[],f=this;b=this.require("db").collections().MenuHeader.find({type:this.designer().type()}),this.header(this.require(b[0]._id)),c=this.require("db").collections().MenuItem.find({type:this.designer().type()}),c.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),c.forEach(function(a){var b=a._id;f.items().push(f.require(b))}),d=this.require("db").collections().MenuAction.find({type:this.designer().type()}),e=this.require("db").collections().MenuSearch.find({type:this.designer().type()}),d=d.concat(e),d.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),d.forEach(function(a){var b=a._id;f.actions().push(f.require(b))})});var d=this.require("MenuItem");d.on("click",function(){this.require("designer").context(this.name())}),c.on("render",function(){function a(){var a=0,b=0,c=null;for(a=f.children.length,b=0;a>b;b++)c=f.children[b],$(c).removeClass("active")}var b=0,c=0,d=null,e=document.getElementById("designer-menubar-header"),f=document.getElementById("designer-menubar-items"),g=document.getElementById("designer-menubar-actions"),h=this;e.insertAdjacentHTML("afterbegin",this.header().html().source()),this.items().forEach(function(a){f.insertAdjacentHTML("beforeend","<li>"+a.html().source()+"</>")});var i=function(){a(),$(this).addClass("active")};for(b=f.children.length,c=0;b>c;c++)d=f.children[c],d.addEventListener("click",i),d.addEventListener("click",function(){this.click()}.bind(h.items(c)));this.actions().forEach(function(a){g.insertAdjacentHTML("afterbegin","<li>"+a.html().source()+"</>")}),b>0&&(this.designer().context(this.items(0).name()),d=f.children[0],$(d).addClass("active"))});var e=this.require("ToolBar");e.on("init",function(a){var b=[],c=this;b=this.require("db").collections().ToolBarItem.find({type:this.designer().type()}),b.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),b.forEach(function(a){var b=a._id;c.items().push(c.require(b))})}),e.on("render",function(){var a=document.getElementById("designer-toolbar-items"),b=0,c=0,d=null,e=this;for(this.items().forEach(function(b){a.insertAdjacentHTML("beforeend","<li>"+b.html().source()+"</>")}),c=a.children.length,b=0;c>b;b++)d=a.children[b],d.addEventListener("click",function(){this.click()}.bind(e.items(b)))});var f=this.require("Workspace");f.on("init",function(a){var b=null,c=null;b=this.require("Editor"),c=new b({_id:"editor",editor:ace.edit("designer-editor")})}),f.on("render",function(){this.require("editor").render()});var g=this.require("Server");g.on("start",function(){function a(a){var b=!1,c=f.getSelectionRange();return b=0===c.end.row&&c.end.column<h+1&&c.intersects(a)}var b=null,c=null,d="",e=this.require("designer"),f=this.require("editor").editor(),g=null,h=null;this.require("storage").on("changed",function(a){"undefined"!=typeof a["system-designer-message"]&&$db.RuntimeMessage.insert(a["system-designer-message"].newValue)},!0),b=this.require("RuntimeChannel"),c=new b({_id:"channel"}),c.on("send",function(a){var b=this.require("storage").get("system-designer-config");this.require("storage").set("system-designer-message",a),"undefined"!=typeof b.debugType&&"server"===b.debugType&&b.urlServer&&$.post(b.urlServer+":8888/"+a.event,encodeURIComponent(JSON.stringify(a.data)))}),d=document.location.href.split("#")[1],systemId=document.location.href.split("#")[2],behavior=this.require("storage").get(systemId).behaviors[d],e.store().uuid(d),e.store().data(behavior),document.title=behavior.state+" | system designer",f.setValue(behavior.action),f.gotoLine(2),f.getSession().$undoManager.reset(),f.getSession().setUndoManager(new ace.UndoManager),g=ace.require("ace/range").Range,h=behavior.action.indexOf("{")+1,f.session.addMarker(new g(0,0,0,h),"readonly"),f.keyBinding.addKeyboardHandler({handleKeyboard:function(b,c,d,e,f){var i=null;switch(!0){case-1===c||40>=e&&e>=37:i=!1;break;case a(new g(0,0,0,h)):i={command:"null",passEvent:!1},runtime.require("message").warning("you can not modify the header of the behavior.")}return i?i:void 0}})},!0);var h=this.require("Editor");h.on("render",function(){this.editor().getSession().setMode("ace/mode/javascript"),this.editor().getSession().setTabSize(2);var b={getCompletions:function(b,c,d,e,f){function g(a){var b=0,c=0;if(a)for(b=a.length,c=0;b>c;c++)if(-1!==a[c].indexOf("RuntimeComponent"))j.push({name:"classInfo()",value:"classInfo()",meta:"property (inherited)"}),j.push({name:"id()",value:"id()",meta:"property (inherited)"}),j.push({name:"on()",value:"on()",meta:"method (inherited)"}),j.push({name:"off()",value:"off()",meta:"method (inherited)"}),j.push({name:"require()",value:"require()",meta:"method (inherited)"}),j.push({name:"destroy()",value:"destroy()",meta:"method (inherited)"}),j.push({name:"init()",value:"init()",meta:"method (inherited)"}),j.push({name:"error()",value:"error()",meta:"event (inherited)"});else{m=h(l,a[c]);for(var d in m)0!==d.indexOf("_")&&j.push({name:d+"()",value:d+"()",meta:m[d]+" (inherited)"});"undefined"!=typeof m._inherit&&g(m._inherit)}}function h(a,b){var c="",d="";for(d in a)if(a[d]._name===b){c=a[d];break}return c}var i="",j=[],k="",l={},m={},n={},o=0;if(id=document.location.href.split("#")[1],i=document.location.href.split("#")[2],a=this.require("storage").get(i)){k=a.behaviors[id].component,l=a.schemas,m=h(l,k);for(var p in m)0!==p.indexOf("_")&&j.push({name:p+"()",value:p+"()",meta:m[p]});if(a.behaviors[id].component===i&&(j.push({name:"classInfo()",value:"classInfo()",meta:"property"}),j.push({name:"id()",value:"id()",meta:"property"}),j.push({name:"on()",value:"on()",meta:"method"}),j.push({name:"off()",value:"off()",meta:"method"}),j.push({name:"require()",value:"require()",meta:"method"}),j.push({name:"destroy()",value:"destroy()",meta:"method"}),j.push({name:"init()",value:"init()",meta:"method"}),j.push({name:"error()",value:"error()",meta:"event"})),n=m._inherit)for(length=n.length,o=0;o<length;o++)if(-1!==n[o].indexOf("RuntimeComponent"))j.push({name:"classInfo()",value:"classInfo()",meta:"property (inherited)"}),j.push({name:"id()",value:"id()",meta:"property (inherited)"}),j.push({name:"on()",value:"on()",meta:"method (inherited)"}),j.push({name:"off()",value:"off()",meta:"method (inherited)"}),j.push({name:"require()",value:"require()",meta:"method (inherited)"}),j.push({name:"destroy()",value:"destroy()",meta:"method (inherited)"}),j.push({name:"init()",value:"init()",meta:"method (inherited)"}),j.push({name:"error()",value:"error()",meta:"event (inherited)"});else{m=h(l,n[o]);for(var q in m)0!==q.indexOf("_")&&j.push({name:q+"()",value:q+"()",meta:m[q]+" (inherited)"});"undefined"!=typeof m._inherit&&g(m._inherit)}}f(null,j)}.bind(this)};this.editor().setOptions({enableBasicAutocompletion:[b]}),this.editor().setShowPrintMargin(!1),this.editor().setReadOnly(!1),this.editor().$blockScrolling=1/0,this.editor().setValue(""),this.editor().commands.addCommand({name:"myCommand",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(a){runtime.require("designer").save()}}),this.editor().focus()}),this.require("1f1781882618110").on("click",function(){var b=this.require("editor").editor(),c=this.require("designer");try{c.store().data(JSON.parse(b.getValue()))}catch(d){}b.getSession().setMode("ace/mode/javascript"),b.getSession().setTabSize(2);var e={getCompletions:function(b,c,d,e,f){function g(a,b){var c="",d="";for(d in a)if(a[d]._name===b){c=a[d];break}return c}var h="",i=[],j="",k={},l={},m={},n=0;if(id=document.location.href.split("#")[1],h=document.location.href.split("#")[2],a=this.require("storage").get(h)){j=a.behaviors[id].component,k=a.schemas,l=g(k,j);for(var o in l)0!==o.indexOf("_")&&i.push({name:o+"()",value:o+"()",meta:l[o]});if(a.behaviors[id].component===h&&(i.push({name:"classInfo()",value:"classInfo()",meta:"property"}),i.push({name:"id()",value:"id()",meta:"property"}),i.push({name:"on()",value:"on()",meta:"method"}),i.push({name:"off()",value:"off()",meta:"method"}),i.push({name:"require()",value:"require()",meta:"method"}),i.push({name:"destroy()",value:"destroy()",meta:"method"}),i.push({name:"init()",value:"init()",meta:"method"}),i.push({name:"error()",value:"error()",meta:"event"})),m=l._inherit)for(length=m.length,n=0;n<length;n++)if(-1!==m[n].indexOf("RuntimeComponent"))i.push({name:"classInfo()",value:"classInfo()",meta:"property (inherited)"}),i.push({name:"id()",value:"id()",meta:"property (inherited)"}),i.push({name:"on()",value:"on()",meta:"method (inherited)"}),i.push({name:"off()",value:"off()",meta:"method (inherited)"}),i.push({name:"require()",value:"require()",meta:"method (inherited)"}),i.push({name:"destroy()",value:"destroy()",meta:"method (inherited)"}),i.push({name:"init()",value:"init()",meta:"method (inherited)"}),i.push({name:"error()",value:"error()",meta:"event (inherited)"});else{l=g(k,m[n]);for(var p in l)0!==p.indexOf("_")&&i.push({name:p+"()",value:p+"()",meta:l[p]+" (inherited)"})}}f(null,i)}.bind(this)};b.setOptions({enableBasicAutocompletion:[e]}),b.setValue(c.store().data().action),b.gotoLine(2),b.getSession().$undoManager.reset(),b.getSession().setUndoManager(new ace.UndoManager),b.focus()}),this.require("1f1781882618111").on("click",function(){var a=this.require("editor").editor(),b=this.require("designer");0!==a.getValue().indexOf("{")&&(b.store().data().action=a.getValue()),a.getSession().setMode("ace/mode/json"),a.setValue(JSON.stringify(b.store().data(),null,"	")),a.gotoLine(2),a.getSession().$undoManager.reset(),a.getSession().setUndoManager(new ace.UndoManager),a.focus()});var i=this.require("Designer");i.on("init",function(a){var b=null,c=null,d=null,e=null,f=null,g=null,h=null,i=null,j=null,k=null;this.type(window.location.href.split(".html")[0].split("/")[window.location.href.split(".html")[0].split("/").length-1]),b=this.require("Store"),c=new b,d=this.require("MenuBar"),e=new d({designer:this}),f=this.require("ToolBar"),g=new f({designer:this}),h=this.require("Workspace"),i=new h({designer:this}),j=this.require("Server"),k=new j({designer:this}),this.store(c),this.menubar(e),this.toolbar(g),this.workspace(i),this.server(k)}),i.on("render",function(){this.menubar().render(),this.toolbar().render(),this.workspace().render(),this.server().start(),this.updateRouter(),$(function(){$('[data-toggle="tooltip"]').tooltip({container:"body",delay:{show:1e3,hide:100}})})}),i.on("updateRouter",function(){var a=[],b=0,c=0,d="",e="",f="";for(d=document.location.href.split("#")[1],e=document.location.href.split("#")[2],a=$("#designer-menubar-items > li > a"),c=a.length,b=0;c>b;b++)f=a[b].href,context=f.split("#")[f.split("#").length-1],a[b].href="#"+d+"#"+e+"#"+context}),i.on("clear",function(){this.refresh()}),i.on("context",function(a){this.workspace().clear(),this.workspace().refresh()}),i.on("save",function(){var a=this.require("editor").editor().getValue(),b=this.require("designer"),c=b.store().data();"action"===b.context()?c.action=a:c=JSON.parse(a),b.store().data(c),b.store().uuid()!==b.store().data()._id&&(this.require("channel").deleteBehavior(b.store().uuid()),b.store().uuid(b.store().data()._id)),document.title=b.store().data().state+" | system designer",this.require("channel").updateBehavior(b.store().uuid(),b.store().data()),this.require("message").success("behavior saved.")}),a.on("main",function(){var a=null,b=null;a=this.require("Designer"),b=new a({_id:"designer"}),b.render()}),a.main()});