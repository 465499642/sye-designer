/*
* System Designer
* https://system-designer.github.io
* @ecarriou
*
* Copyright 2016 Erwan Carriou
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/
runtime.on("ready",function(){runtime.on("ready",function(){var a=runtime.system("app");a.on("main",function(){var a=null,b=null,c="",d="";c=document.location.href.split("#")[1],d=this.require("storage").get(c),delete d.classInfo,a=this.require("RuntimeChannel"),b=new a({_id:"channel",_core:!0}),b.on("send",function(a){this.require("storage").set("system-designer-message",a)}),b.on("createSchema",function(a,b){this.require("metamodel").schema(b),this.require("metamodel").create()},!0),b.on("updateSchema",function(a,b){this.require("metamodel").schema(b),this.require("metamodel").create()},!0),b.on("deleteSchema",function(a){var b=$db.RuntimeSchema.find({_id:a}),c="",d="";b.length&&(c=b[0]._name,$db.RuntimeSchema.remove({_id:a}),b=$db.RuntimeModel.find({_name:c}),b.length&&(d=b[0]._id,$db.RuntimeModel.remove({_id:d}),$component.removeFromMemory(c)),b=$db.RuntimeGeneratedModel.find({_name:c}),b.length&&(d=b[0]._id,$db.RuntimeGeneratedModel.remove({_id:d}),$component.removeFromMemory(c)),this.require("metamodel").create())},!0),b.on("createModel",function(a,b){this.require("metamodel").model(b),this.require("metamodel").create()},!0),b.on("updateModel",function(a,b){this.require("metamodel").model(b),this.require("metamodel").create()},!0),b.on("deleteModel",function(a){var b=$db.RuntimeModel.find({_id:a}),c="",d="";b.length&&(c=b[0]._name,$db.RuntimeModel.remove({_id:a}),$component.removeFromMemory(c)),b=$db.RuntimeGeneratedModel.find({_name:c}),b.length&&(d=b[0]._id,$db.RuntimeGeneratedModel.remove({_id:d}),$component.removeFromMemory(c)),this.require("metamodel").create()},!0),b.on("createType",function(a,b){this.require("metamodel").type(b),this.require("metamodel").create()},!0),b.on("updateType",function(a,b){this.require("metamodel").type(b),this.require("metamodel").create()},!0),b.on("deleteType",function(a){$db.RuntimeType.remove({name:a}),this.require("metamodel").create()},!0),b.on("createComponent",function(a,b){$db[a].insert(b)},!0),b.on("updateComponent",function(a,b,c){$db[b].update({_id:a},c)},!0),b.on("deleteComponent",function(a,b){$db[b].remove({_id:a})},!0),b.on("createBehavior",function(a){$db.RuntimeBehavior.insert(a)},!0),b.on("updateBehavior",function(a,b){this.require(a).action(b.action)}),b.on("deleteBehavior",function(a){$db.RuntimeBehavior.remove({_id:a})},!0),b.on("sync",function(){this.loadSystem(JSON.parse(this.require("db").system()))}),this.require("storage").on("changed",function(a){"undefined"!=typeof a["system-designer-message"]&&$db.RuntimeMessage.insert(a["system-designer-message"].newValue)},!0),this.require("logger").on("warn",function(a){var b=new Date,c=b.toLocaleTimeString();this.require("channel").logWarn("["+c+"] "+a)}),this.require("logger").on("error",function(a){var b=new Date,c=b.toLocaleTimeString();this.require("channel").logError("["+c+"] "+a)}),this.require("logger").info("loading the system...");var e=this.require("db").system(d);this.require("logger").info("the system is loaded"),document.title=d.name,this.require("logger").on("debug",function(a){var b=new Date,c=b.toLocaleTimeString();this.require("channel").logDebug("["+c+"] "+a)}),this.require("logger").on("info",function(a){var b=new Date,c=b.toLocaleTimeString();this.require("channel").logInfo("["+c+"] "+a)}),this.require("logger").level("debug"),this.require(e).main()},!0),a.main()})});