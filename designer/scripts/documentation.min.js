/*
* System Designer
* https://system-designer.github.io
* @ecarriou
*
* Copyright (C) 2016 - Erwan Carriou
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
runtime.on("ready",function(){var a=this.system("design"),b=this.require("DialogCopyright");b.on("init",function(a){var b="",c=null;$("#designer-dialog-copyright").empty(),b=this.require("dialog-modal-copyright.html"),document.querySelector("#designer-dialog-copyright").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-copyright-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),b.on("show",function(){$("#designer-dialog-copyright-modal").modal("show")}),b.on("hide",function(){$("#designer-dialog-copyright-modal").modal("hide")});var c=this.require("MenuBar");c.on("init",function(a){var b=[],c=[],d=[],e=[],f=this;b=this.require("db").collections().MenuHeader.find({type:this.designer().type()}),this.header(this.require(b[0]._id)),c=this.require("db").collections().MenuItem.find({type:this.designer().type()}),c.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),c.forEach(function(a){var b=a._id;f.items().push(f.require(b))}),d=this.require("db").collections().MenuAction.find({type:this.designer().type()}),e=this.require("db").collections().MenuSearch.find({type:this.designer().type()}),d=d.concat(e),d.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),d.forEach(function(a){var b=a._id;f.actions().push(f.require(b))})}),c.on("render",function(){function a(){var a=0,b=0,c=null;for(a=f.children.length,b=0;a>b;b++)c=f.children[b],$(c).removeClass("active")}var b=0,c=0,d=null,e=document.getElementById("designer-menubar-header"),f=document.getElementById("designer-menubar-items"),g=document.getElementById("designer-menubar-actions"),h=window.location.href.split("#"),i="overview",j=this.require("designer"),k=this;for(e.insertAdjacentHTML("afterbegin",this.header().html().source()),this.items().forEach(function(a){f.insertAdjacentHTML("beforeend","<li>"+a.html().source()+"</>")}),b=f.children.length,c=0;b>c;c++)d=f.children[c],d.addEventListener("click",function(){a(),$(this).addClass("active")}),d.addEventListener("click",function(){this.click()}.bind(k.items(c)));for(this.actions().forEach(function(a){g.insertAdjacentHTML("afterbegin","<li>"+a.html().source()+"</>")}),h.length>1&&(i=h[1].trim()),c=0;b>c;c++)this.items(c).name()===i&&(d=f.children[c],$(d).addClass("active"));j.context(i)});var d=this.require("ToolBar");d.on("init",function(a){var b=[],c=this;b=this.require("db").collections().ToolBarItem.find({type:this.designer().type()}),b.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),b.forEach(function(a){var b=a._id;c.items().push(c.require(b))})}),d.on("render",function(){var a=document.getElementById("designer-toolbar-items"),b=0,c=0,d=null,e=this;for(this.items().forEach(function(b){a.insertAdjacentHTML("beforeend","<li>"+b.html().source()+"</>")}),c=a.children.length,b=0;c>b;b++)d=a.children[b],d.addEventListener("click",function(){this.click()}.bind(e.items(b)))});var e=this.require("Workspace");e.on("clear",function(){$("#designer-documentation").empty()}),e.on("render",function(){var a="",b=this.require("designer").context();b&&(a=this.require("documentation-"+b+".html"),document.querySelector("#designer-documentation").insertAdjacentHTML("afterbegin",a.source()),Prism.highlightAll())});var f=this.require("Server");f.on("start",function(){var a=null,b=null,c=null,d=null;a=this.require("Worker"),b=new a({_id:"worker",worker:new SharedWorker("./scripts/worker.js")}),b.worker().port.onmessage=function(a){$db.RuntimeMessage.insert(a.data)},c=this.require("RuntimeChannel"),d=new c({_id:"channel"}),d.on("send",function(a){this.require("worker").worker().port.postMessage(a)})},!0);var g=this.require("Designer");g.on("init",function(a){var b=null,c=null,d=null,e=null,f=null,g=null,h=null,i=null,j=null,k=null;this.type(window.location.href.split(".html")[0].split("/")[window.location.href.split(".html")[0].split("/").length-1]),b=this.require("Store"),c=new b,d=this.require("MenuBar"),e=new d({designer:this}),f=this.require("ToolBar"),g=new f({designer:this}),h=this.require("Workspace"),i=new h({designer:this}),j=this.require("Server"),k=new j({designer:this}),this.store(c),this.menubar(e),this.toolbar(g),this.workspace(i),this.server(k);var l=this;window.onhashchange=function(a){var b=window.location.href.split("#"),c="overview",d=null,e=null,f=0;for(b.length>1&&(c=b[1]),l.context(c),d=document.getElementById("designer-menubar-items"),length=l.menubar().items().length,f=0;f<length;f++)e=d.children[f],$(e).removeClass("active");for(f=0;f<length;f++)l.menubar().items(f).name()===c&&(e=d.children[f],$(e).addClass("active"))}}),g.on("render",function(){this.menubar().render(),this.toolbar().render(),this.server().start()}),g.on("clear",function(){this.refresh()}),g.on("context",function(a){this.workspace().clear(),this.workspace().render()}),a.on("main",function(){var a=null,b=null;a=this.require("Designer"),b=new a({_id:"designer"}),b.render()}),a.main()});