/*
* System Designer
* https://system-designer.github.io
* @ecarriou
*
* Copyright (C) 2016 - Erwan Carriou
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
runtime.on("ready",function(){var a=this.system("design"),b=this.require("DialogImport");b.on("init",function(a){var b="",c=null;$("#designer-dialog-import").empty(),b=this.require("dialog-modal-import.html"),document.querySelector("#designer-dialog-import").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-import-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-import-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),b.on("show",function(){$("#designer-dialog-import-modal").modal("show")}),b.on("hide",function(){$("#designer-dialog-import-modal").modal("hide")});var c=this.require("DialogCheck");c.on("init",function(a){var b="",c=null;$("#designer-dialog-check").empty(),b=this.require("dialog-modal-check.html"),document.querySelector("#designer-dialog-check").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-check-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),c.on("show",function(){$("#designer-dialog-check-modal").modal("show")}),c.on("hide",function(){$("#designer-dialog-check-modal").modal("hide")}),c.on("ok",function(){this.hide()});var d=this.require("DialogWelcome");d.on("init",function(a){var b="",c=null;$("#designer-dialog-welcome").empty(),b=this.require("dialog-modal-welcome.html"),document.querySelector("#designer-dialog-welcome").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-welcome-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),d.on("show",function(){$("#designer-dialog-welcome-modal").modal("show")}),d.on("hide",function(){$("#designer-dialog-welcome-modal").modal("hide")});var e=this.require("DialogSync");e.on("init",function(a){var b="",c=null;$("#designer-dialog-sync").empty(),b=this.require("dialog-modal-sync.html"),document.querySelector("#designer-dialog-sync").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-sync-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),e.on("show",function(){$("#designer-dialog-sync-modal").modal("show")}),e.on("hide",function(){$("#designer-dialog-sync-modal").modal("hide")});var f=this.require("DialogShare");f.on("init",function(a){var b=null,c=null,d="";$("#designer-dialog-share").empty(),d=this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0],b=this.require("dialog-modal-share.html"),document.querySelector("#designer-dialog-share").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,window.location.toString().split("#")[0]+"?system="+encodeURI(JSON.stringify(d)))),c=document.getElementById("designer-dialog-share-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-share-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),f.on("show",function(){$("#designer-dialog-share-modal").modal("show")}),f.on("hide",function(){$("#designer-dialog-share-modal").modal("hide")});var g=this.require("DialogCopyright");g.on("init",function(a){var b="",c=null;$("#designer-dialog-copyright").empty(),b=this.require("dialog-modal-copyright.html"),document.querySelector("#designer-dialog-copyright").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-copyright-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),g.on("show",function(){$("#designer-dialog-copyright-modal").modal("show")}),g.on("hide",function(){$("#designer-dialog-copyright-modal").modal("hide")});var h=this.require("DialogConfig");h.on("init",function(a){var b="",c=null,d=this,e=d.require("designer");$("#designer-dialog-config").empty(),b=this.require("dialog-modal-config.html"),document.querySelector("#designer-dialog-config").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),$("#designer-dialog-type-config-isdebug")[0].checked=e.debug(),c=document.getElementById("designer-dialog-config-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-config-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this)),c=document.getElementById("designer-dialog-type-config-reset"),c.addEventListener("click",function(a){this.require("System");window.localStorage.clear(),this.require("designer").system().destroy(),this.require("designer").spaces().clear(),this.require("designer").workspace().clear(),this.require("designer").updateRouter(),this.require("message").success("system designer has been reseted.")}.bind(this)),c=document.getElementById("designer-dialog-type-config-isdebug"),c.addEventListener("click",function(a){var b=d.require("designer"),c=!1;c=$("#designer-dialog-type-config-isdebug")[0].checked,c?b.debug(!0):b.debug(!1)})}),h.on("show",function(){$("#designer-dialog-config-modal").modal("show")}),h.on("hide",function(){$("#designer-dialog-config-modal").modal("hide")});var i=this.require("DialogImportFile");i.on("init",function(a){var b="",c=null,d=this,e=[],f="",g=0,h=0,i="";for($("#designer-dialog-import-file").empty(),e=this.require("db").collections().JSON.find(),g=e.length,h=0;g>h;h++)f=this.require(e[h]._id),i=i+'<a class="list-group-item" id="designer-dialog-import-file-modal-library-'+f.id()+'"><h4 class="list-group-item-heading">'+JSON.parse(decodeURI(f.source())).name+'</h4><p class="list-group-item-text">'+JSON.parse(decodeURI(f.source())).description+"</p></a>";for(b=this.require("dialog-modal-import-file.html"),document.querySelector("#designer-dialog-import-file").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{library}}/gi,i)),h=0;g>h;h++)f=this.require(e[h]._id),c=document.getElementById("designer-dialog-import-file-modal-library-"+f.id()),c.addEventListener("click",function(a){var b="",c=null,e=0,f=0;if($(this).hasClass("active"))$(this).removeClass("active"),d.data(null);else{for(b=this.getAttribute("id").replace("designer-dialog-import-file-modal-library-",""),d.data(JSON.parse(decodeURI(d.require(b).source()))),c=document.getElementById("designer-dialog-import-file-modal-library"),e=c.children.length,f=0;e>f;f++)$(c.children[f]).removeClass("active");$(this).addClass("active")}});c=document.getElementById("designer-dialog-import-modal-from-file"),c.addEventListener("click",function(a){$("#designer-dialog-import-file-modal-file").show(),$("#designer-dialog-import-file-modal-well").hide()}.bind(this)),c=document.getElementById("designer-dialog-import-modal-from-library"),c.addEventListener("click",function(a){$("#designer-dialog-import-file-modal-well").show(),$("#designer-dialog-import-file-modal-file").hide()}.bind(this)),c=document.getElementById("designer-dialog-import-file-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-import-file-modal-merge"),c.addEventListener("click",function(a){this.mergeSystem()}.bind(this)),c=document.getElementById("designer-dialog-import-file-modal-import"),c.addEventListener("click",function(a){this.importSystem()}.bind(this)),c=document.getElementById("designer-dialog-import-file-modal-file"),c.addEventListener("change",function(a){a.stopPropagation(),a.preventDefault();var b=a.target.files,c=new FileReader,d="",e=this;c.onload=function(a){d+=a.target.result},c.onloadend=function(){try{e.data(JSON.parse(d))}catch(a){e.data({})}},c.readAsText(b[0],"UTF-8")}.bind(this))}),i.on("show",function(){$("#designer-dialog-import-file-modal").modal("show")}),i.on("hide",function(){$("#designer-dialog-import-file-modal").modal("hide")});var j=this.require("DialogDropFile");j.on("init",function(a){var b=null,c=null;$("#designer-dialog-drop-file").empty(),b=this.require("dialog-modal-drop-file.html"),document.querySelector("#designer-dialog-drop-file").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("designer-dialog-drop-file-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-drop-file-modal-merge"),c.addEventListener("click",function(a){this.mergeSystem()}.bind(this)),c=document.getElementById("designer-dialog-drop-file-modal-import"),c.addEventListener("click",function(a){this.importSystem()}.bind(this))}),j.on("mergeSystem",function(){var a=null,b="",c="",d="",e="",f=this.require("designer"),g=f.system(),h=this.require("message");if(a=this.data(),Object.keys(a).length){for(b in a.schemas)if(g.schemas()[b])for(d in a.schemas[b])g.schemas()[b][d]=a.schemas[b][d];else g.schemas()[b]=a.schemas[b];for(b in a.models)if(g.models()[b])for(d in a.models[b])g.models()[b][d]=a.models[b][d];else g.models()[b]=a.models[b];for(b in a.types)if(g.types()[b])for(d in a.types[b])g.types()[b][d]=a.types[b][d];else g.types()[b]=a.types[b];for(b in a.behaviors)b!==a._id&&(g.behaviors()[b]=a.behaviors[b]);for(c in a.components){g.components()[c]||(g.components()[c]={});for(e in a.components[c])if(g.components()[c][e])for(d in a.components[c][e])g.components()[c][e][d]=a.components[c][e][d];else g.components()[c][e]=a.components[c][e]}}f.save(),f.workspace().refresh(),this.hide(),f.save(),h.success("merge of the system is done.")}),j.on("importSystem",function(){var a=this.require("System"),b=null,c=this.require("designer"),d=this.require("message");c.system()&&c.system().destroy(),b=new a(this.data()),c.system(b),c.save(),c.space(b.name()),c.spaces().render(),c.workspace().refresh(),this.hide(),c.save(),d.success("importation of the system is done.")}),j.on("show",function(){$("#designer-dialog-drop-file-modal").modal("show")}),j.on("hide",function(){$("#designer-dialog-drop-file-modal").modal("hide")});var k=this.require("DialogTypeCreation");k.on("init",function(a){var b="",c=null;$("#designer-dialog-type-creation").empty(),b=this.require("dialog-modal-type-creation.html"),document.querySelector("#designer-dialog-type-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-type-creation-name"),c.addEventListener("keydown",function(a){return 13===a.keyCode?(a.stopPropagation(),a.preventDefault(),$("#designer-dialog-type-creation-name").val()&&this.ok(),!1):void 0}.bind(this)),c=document.getElementById("designer-dialog-type-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-type-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),k.on("show",function(){$("#designer-dialog-type-creation-modal").modal("show")}),k.on("hide",function(){$("#designer-dialog-type-creation-modal").modal("hide")});var l=this.require("DialogExport");l.on("init",function(a){var b="",c=null;$("#designer-dialog-export").empty(),b=this.require("dialog-modal-export.html"),document.querySelector("#designer-dialog-export").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-export-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-export-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),l.on("show",function(){$("#designer-dialog-export-modal").modal("show")}),l.on("hide",function(){$("#designer-dialog-export-modal").modal("hide")});var m=this.require("DialogSchemaCreation");m.on("init",function(a){var b="",c=null;$("#designer-dialog-schema-creation").empty(),b=this.require("dialog-modal-schema-creation.html"),document.querySelector("#designer-dialog-schema-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-schema-creation-name"),c.addEventListener("keydown",function(a){return 13===a.keyCode?(a.stopPropagation(),a.preventDefault(),$("#designer-dialog-schema-creation-name").val()&&this.ok(),!1):void 0}.bind(this)),c=document.getElementById("designer-dialog-schema-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-schema-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),m.on("show",function(){$("#designer-dialog-schema-creation-modal").modal("show")}),m.on("hide",function(){$("#designer-dialog-schema-creation-modal").modal("hide")});var n=this.require("DialogSystemCreation");n.on("init",function(a){var b="",c=null;$("#designer-dialog-system-creation").empty(),b=this.require("dialog-modal-system-creation.html"),document.querySelector("#designer-dialog-system-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("designer-dialog-system-creation-name"),c.addEventListener("keydown",function(a){return 13===a.keyCode?(a.stopPropagation(),a.preventDefault(),$("#designer-dialog-system-creation-name").val()&&this.ok(),!1):void 0}.bind(this)),c=document.getElementById("designer-dialog-system-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-system-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),n.on("show",function(){$("#designer-dialog-system-creation-modal").modal("show")}),n.on("hide",function(){$("#designer-dialog-system-creation-modal").modal("hide")});var o=this.require("DialogModelCreation");o.on("init",function(a){var b="",c=null,d="",e=this.require("designer"),f=e.system().schemas();$("#designer-dialog-model-creation").empty();for(name in f)d=d+'<option value="'+name+'">'+name+"</option>";b=this.require("dialog-modal-model-creation.html"),document.querySelector("#designer-dialog-model-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{schemas}}/gi,d)),c=document.getElementById("designer-dialog-model-creation-name"),c.addEventListener("keydown",function(a){return 13===a.keyCode?(a.stopPropagation(),a.preventDefault(),$("#designer-dialog-model-creation-name").val()&&this.ok(),!1):void 0}.bind(this)),c=document.getElementById("designer-dialog-model-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-model-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),o.on("show",function(){$("#designer-dialog-model-creation-modal").modal("show")}),o.on("hide",function(){$("#designer-dialog-model-creation-modal").modal("hide")});var p=this.require("DialogBehaviorCreation");p.on("init",function(a){var b="",c=null,d="",e=[],f=this.require("designer"),g=this.require("designer").space(),h=(f.system().schemas(),f.system().models()),i="";if($("#designer-dialog-behavior-creation").empty(),g!==f.system().name()){i=h[g]._schema,e.push("init"),e.push("destroy");for(name in f.system().schemas()[i])switch(f.system().schemas()[i][name]){case"property":case"link":case"collection":case"event":case"method":e.push(name)}}else e.push("main");e.sort(),e.forEach(function(a){d=d+'<option value="'+a+'">'+a+"</option>"}),b=this.require("dialog-modal-behavior-creation.html"),document.querySelector("#designer-dialog-behavior-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{states}}/gi,d)),c=document.getElementById("designer-dialog-behavior-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-behavior-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),p.on("show",function(){$("#designer-dialog-behavior-creation-modal").modal("show")}),p.on("hide",function(){$("#designer-dialog-behavior-creation-modal").modal("hide")});var q=this.require("DialogComponentCreation");q.on("init",function(a){var b="",c=null,d="",e=this.require("designer"),f=e.system().models();$("#designer-dialog-component-creation").empty();for(name in f)f[name]._schema&&(d=d+'<option value="'+name+'">'+name+"</option>");b=this.require("dialog-modal-component-creation.html"),document.querySelector("#designer-dialog-component-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{models}}/gi,d)),c=document.getElementById("designer-dialog-component-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("designer-dialog-component-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),q.on("show",function(){$("#designer-dialog-component-creation-modal").modal("show")}),q.on("hide",function(){$("#designer-dialog-component-creation-modal").modal("hide")});var r=this.require("ModelSystem");r.on("render",function(){var a=null,b=this,c="",d="",e="";a=this.require("model-system.html");for(d in this.document())-1!==["name","description","version"].indexOf(d)&&(e=this.document()[d],c=c+"<tr><td>"+d+"</td><td>"+e+"</td></tr>");document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,this.uuid()).replace(/{{content}}/gi,c)),a=document.getElementById("designer-system-"+this.uuid()).children[0].children[1],a.addEventListener("click",function(a){window.open("system.html?_id="+b.uuid())}),a=document.getElementById("designer-system-"+this.uuid()+"-edit"),a.addEventListener("click",function(a){window.open("system.html?_id="+b.uuid())}),a=document.getElementById("designer-system-"+this.uuid()+"-delete"),a.addEventListener("click",function(a){var b=JSON.parse(window.localStorage.getItem("systems")),c=this.require("designer"),d=this.require("System"),e=this.uuid();window.localStorage.removeItem(e),b.systems.splice(b.systems.indexOf(e),1),window.localStorage.setItem("systems",JSON.stringify(b)),c.system().destroy(),b.systems.length&&c.system(new d(JSON.parse(window.localStorage.getItem(b.systems[0])))),$("#designer-system-"+this.uuid()).remove(),this.destroy(),c.space(""),c.spaces().render(),c.workspace().refresh()}.bind(this))}),r.on("hide",function(){$("#designer-system-"+this.uuid()).hide()}),r.on("show",function(){$("#designer-system-"+this.uuid()).show()});var s=this.require("ModelType");s.on("render",function(){var a=null,b=this,c="",d="",e="";if(a=this.require("model-type.html"),this.document().schema)for(d in this.document().schema)this.document().schema.hasOwnProperty(d)&&(e=this.document().schema[d].type,c=c+'<a class="list-group-item" style="text-align: left">'+d+" : "+e+"</a>");this.document().value&&this.document().value.forEach(function(a){c=c+'<a class="list-group-item" style="text-align: left">'+a+"</a>"}),this.document().schema||this.document().value||(e=this.document().type,c=c+'<a class="list-group-item" style="text-align: left"><i>alias</i> : '+e+"</a>"),""===c&&(c+='<a class="list-group-item" style="text-align: left"><br/><br/></a>'),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{id}}/gi,this.uuid()).replace(/{{content}}/gi,c)),a=document.getElementById("designer-type-"+this.uuid()).children[0].children[1],a.addEventListener("click",function(a){window.open("type.html?_id="+b.uuid())}),a=document.getElementById("designer-type-"+this.uuid()+"-edit"),a.addEventListener("click",function(a){window.open("type.html?_id="+b.uuid())}),a=document.getElementById("designer-type-"+this.uuid()+"-delete"),a.addEventListener("click",function(a){var b=this.require("designer");delete b.system().types()[this.title()],$("#designer-type-"+this.title()).remove(),this.require("channel").deleteType(this.uuid()),this.destroy(),b.save(),b.space(""),b.spaces().render(),b.workspace().refresh()}.bind(this))}),s.on("hide",function(){$("#designer-type-"+this.title()).hide()}),s.on("show",function(){$("#designer-type-"+this.title()).show()});var t=this.require("ModelSchema");t.on("render",function(){var a=null,b="",c=this,d="",e="";a=this.require("model-schema.html");for(d in this.document())this.document().hasOwnProperty(d)&&0!==d.indexOf("_")&&(e=this.document()[d],b=b+"<tr><td>"+d+"</td><td>"+e+"</td></tr>");""===b&&(b+="<tr><td><br/><br/><br/></td><td><br/><br/><br/></td></tr>"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{id}}/gi,this.title()).replace(/{{content}}/gi,b)),"RuntimeComponent"!==this.uuid()?(a=document.getElementById("designer-schema-"+this.uuid()).children[0].children[1],a.addEventListener("click",function(a){window.open("schema.html?_id="+c.uuid())}),a=document.getElementById("designer-schema-"+this.uuid()+"-edit"),a.addEventListener("click",function(a){window.open("schema.html?_id="+c.uuid())}),a=document.getElementById("designer-schema-"+this.uuid()+"-delete"),a.addEventListener("click",function(a){var b=this.require("designer");delete b.system().schemas()[this.title()],$("#designer-schema-"+this.title()).remove(),this.require("channel").deleteSchema(this.uuid()),this.destroy(),b.save(),b.space(""),b.spaces().render(),b.workspace().refresh()}.bind(this))):($("#designer-model-panel-RuntimeComponentSchema div div").hide(),$("#designer-schema-RuntimeComponentSchema > div > .panel-body").attr("style","cursor: inherit"))}),t.on("hide",function(){$("#designer-schema-"+this.title()).hide()}),t.on("show",function(){$("#designer-schema-"+this.title()).show()});var u=this.require("ModelClass");u.on("render",function(){var a=null,b=this,c="",d="",e="",f="",g="",h="",i=null;for(c in this.document())if(this.document().hasOwnProperty(c))switch(h=this.document()[c],!0){case"undefined"!=typeof h.type:d=Array.isArray(h.type)?-1!==h.type[0].indexOf("@")?"RuntimeComponent"!==this.uuid()?d+'<div class="list-group-item" style="text-align: left">+ '+c+' : <a href="#'+this.require("designer").system().id()+"#models#"+h.type[0].replace("@","")+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+h.type[0].replace("@","")+"</a> [ ]</div>":d+'<div class="list-group-item" style="text-align: left">+ '+c+" : "+h.type[0].replace("@","")+" [ ]</div>":-1===["boolean","string","number","object","function","array","html","javascript","css"].indexOf(h.type)?"RuntimeComponent"!==this.uuid()?d+'<div class="list-group-item" style="text-align: left">+ '+c+' : <a href="#'+this.require("designer").system().id()+"#types#"+h.type[0]+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+h.type[0].replace("@","")+"</a> [ ]</div>":d+'<div class="list-group-item" style="text-align: left">+ '+c+" : "+h.type[0].replace("@","")+" [ ]</div>":d+'<div class="list-group-item" style="text-align: left">+ '+c+" : "+h.type[0]+" [ ]</div>":-1!==h.type.indexOf("@")?"RuntimeComponent"!==this.uuid()&&"@RuntimeComponent"!==h.type?d+'<div class="list-group-item" style="text-align: left">+ '+c+' : <a href="#'+this.require("designer").system().id()+"#models#"+h.type.replace("@","")+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+h.type.replace("@","")+"</a></div>":d+'<div class="list-group-item" style="text-align: left">+ '+c+" : "+h.type.replace("@","")+"</div>":-1===["boolean","string","number","object","function","array","html","javascript","css"].indexOf(h.type)&&"RuntimeComponent"!==this.uuid()?d+'<div class="list-group-item" style="text-align: left">+ '+c+' : <a href="#'+this.require("designer").system().id()+"#types#"+h.type+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+h.type+"</a></div>":d+'<div class="list-group-item" style="text-align: left">+ '+c+" : "+h.type+"</div>";break;case"undefined"!=typeof h.params:var j="undefined",k="(";h.params.forEach(function(a){k=k+a.name+" : "+a.type+", "}),k+=")",k=k.replace(", )",")"),"undefined"!=typeof h.result?(j=h.result,f="RuntimeComponent"!==this.uuid()?f+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+c+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+c+"</a>"+k+": "+j+"</div>":f+'<div class="list-group-item" style="text-align: left">+ '+c+k+": "+j+"</div>"):f="RuntimeComponent"!==this.uuid()?f+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+c+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+c+"</a>"+k+"</div>":f+'<div class="list-group-item" style="text-align: left">+ '+c+k+"</div>";break;case-1!==c.indexOf("_"):break;default:var j="undefined";"undefined"!=typeof h.result?(j=h.result,f="RuntimeComponent"!==this.uuid()?f+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+c+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+c+"</a>(): "+j+"</div>":f+'<div class="list-group-item" style="text-align: left">+ '+c+"(): "+j+"</div>"):f="RuntimeComponent"!==this.uuid()?f+'<div class="list-group-item" style="text-align: left">+ <a href="#'+this.require("designer").system().id()+"#behaviors#"+this.document()._name+"#"+c+'" onclick="(function (e) {e.stopPropagation();})(arguments[0])">'+c+"</a>()</div>":f+'<div class="list-group-item" style="text-align: left">+ '+c+"()</div>"}""===d&&(d+='<a class="list-group-item" style="text-align: left"><br/></a>'),""===f&&(f+='<a class="list-group-item" style="text-align: left"><br/></a>'),i=this.require("model-class.html"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",i.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,this.uuid()).replace(/{{attributes}}/gi,d).replace(/{{collections}}/gi,e).replace(/{{methods}}/gi,f).replace(/{{events}}/gi,g)),"RuntimeComponent"!==this.uuid()?(a=document.getElementById("designer-model-"+this.uuid()).children[0].children[1],a.addEventListener("click",function(a){window.open("model.html?_id="+b.uuid())}),a=document.getElementById("designer-model-"+this.uuid()+"-edit"),a.addEventListener("click",function(a){window.open("schema.html?_id="+b.uuid())}),a=document.getElementById("designer-model-"+this.uuid()+"-delete"),a.addEventListener("click",function(a){var b=this.require("designer");delete b.system().models()[this.title()],delete b.system().components()[this.title()],$("#designer-model-"+this.title()).remove(),this.require("channel").deleteModel(this.uuid()),this.destroy(),b.save(),b.space(""),b.spaces().render(),b.workspace().refresh()}.bind(this))):($("#designer-model-RuntimeComponent > div > div > div > button").hide(),$("#designer-model-RuntimeComponent > div > .panel-body").attr("style","cursor: inherit"))}),u.on("hide",function(){$("#designer-class-"+this.title()).hide()}),u.on("show",function(){$("#designer-class-"+this.title()).show()});var v=this.require("ModelBehavior");v.on("render",function(){var a="",b=null,c=this;a=this.require("model-behavior.html"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{_id}}/gi,this.uuid()).replace(/{{title}}/gi,this.title()).replace(/{{content}}/gi,this.content())),b=document.getElementById("designer-behavior-"+this.uuid()).children[0].children[1],b.addEventListener("click",function(a){window.open("behavior.html?_id="+c.uuid())}),b=document.getElementById("designer-behavior-"+this.uuid()+"-edit"),b.addEventListener("click",function(a){window.open("behavior.html?_id="+c.uuid())}),b=document.getElementById("designer-behavior-"+this.uuid()+"-delete"),b.addEventListener("click",function(a){var b=this.require("designer");delete b.system().behaviors()[this.uuid()],$("#designer-behavior-"+this.uuid()).fadeOut(400,function(){$(this).remove()}),this.require("channel").deleteBehavior(this.uuid()),this.destroy(),b.save()}.bind(this))}),v.on("hide",function(){$("#designer-behavior-"+this.uuid()).hide()}),v.on("show",function(){$("#designer-behavior-"+this.uuid()).show()});var w=this.require("ModelComponent");w.on("render",function(){var a=null,b=null,c="",d=this,e="",f="";for(e in this.document())this.document().hasOwnProperty(e)&&"_id"!==e&&(f=this.document()[e],c=c+"<tr><td>"+e+"</td><td>"+JSON.stringify(f)+"</td></tr>");""===c&&(c+="<tr><td><br/><br/></td><td><br/><br/></td></tr>"),a=this.require("model-component.html"),document.querySelector("#designer-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,this.uuid()).replace(/{{content}}/gi,c)),b=document.getElementById("designer-component-"+this.uuid()).children[0].children[1],b.addEventListener("click",function(a){window.open("component.html?_id="+encodeURI(d.title())+"&model="+encodeURI(d.model()))}),b=document.getElementById("designer-component-"+this.uuid()+"-edit"),b.addEventListener("click",function(a){window.open("component.html?_id="+encodeURI(d.title())+"&model="+encodeURI(d.model()))}),b=document.getElementById("designer-component-"+this.uuid()+"-delete"),b.addEventListener("click",function(a){var b=this.require("designer");delete b.system().components()[this.model()][this.uuid()],$("#designer-component-"+this.uuid()).fadeOut(400,function(){$(this).remove()}),this.require("channel").deleteComponent(this.uuid(),this.model()),this.destroy(),b.save()}.bind(this))}),w.on("hide",function(){$("#designer-component-"+this.uuid()).hide()}),w.on("show",function(){$("#designer-component-"+this.uuid()).show()});var x=this.require("MenuBar");x.on("init",function(a){var b=[],c=[],d=[],e=this;b=this.require("db").collections().MenuHeader.find({type:"designer"}),this.header(this.require(b[0]._id)),c=this.require("db").collections().MenuItem.find({type:"designer"}),c.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),c.forEach(function(a){var b=a._id;e.items().push(e.require(b))}),d=this.require("db").collections().MenuAction.find({type:"designer"}),d.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),d.forEach(function(a){var b=a._id;e.actions().push(e.require(b))})}),x.on("render",function(){function a(){var a=0,b=0,c=null;for(a=f.children.length,b=0;a>b;b++)c=f.children[b],$(c).removeClass("active")}var b=0,c=0,d=null,e=document.getElementById("designer-menubar-header"),f=document.getElementById("designer-menubar-items"),g=document.getElementById("designer-menubar-actions"),h=this,i=window.location.href.split("#"),j="system",k="",l=this.require("designer");for(e.insertAdjacentHTML("afterbegin",this.header().html().source()),this.items().forEach(function(a){f.insertAdjacentHTML("beforeend","<li>"+a.html().source()+"</>")}),b=f.children.length,c=0;b>c;c++)d=f.children[c],d.addEventListener("click",function(){a(),$(this).addClass("active")}),d.addEventListener("click",function(){this.click()}.bind(h.items(c)));for(this.actions().forEach(function(a){g.insertAdjacentHTML("afterbegin","<li>"+a.html().source()+"</>")}),i.length>2&&0!==i[2].length&&(j=i[2]),i.length>3&&(k=i[3]),i.length>4&&l.state().component(i[4]),c=0;b>c;c++)this.items(c).name()===j&&(d=f.children[c],$(d).addClass("active"));k&&l.space(k),l.context(j);var m=this;$("#designer-menu-action-search").on("keyup",function(a){var b=$("#designer-menu-action-search").val();m.designer().filter(b)}),l.updateRouter()});var y=this.require("ToolBar");y.on("init",function(a){var b=[],c=this;b=this.require("db").collections().ToolBarItem.find({
type:"designer"}),b.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),b.forEach(function(a){var b=a._id;c.items().push(c.require(b))})}),y.on("render",function(){var a=document.getElementById("designer-toolbar-items"),b=0,c=0,d=null,e=this;for(this.items().forEach(function(b){a.insertAdjacentHTML("beforeend","<li>"+b.html().source()+"</>")}),c=a.children.length,b=0;c>b;b++)d=a.children[b],d.addEventListener("click",function(){this.click()}.bind(e.items(b)))});var z=this.require("Spaces");z.on("init",function(a){}),z.on("clear",function(){this.require("designer").space(""),$("#designer-spaces-items").empty()}),z.on("render",function(){function a(){var a=0,b=0,c=null;for(a=f.children.length,b=0;a>b;b++)c=f.children[b],$(c).removeClass("active")}var b=null,c=this.designer().system(),d=this.require("SpaceItem"),e=null,f=document.getElementById("designer-spaces-items"),g=this;switch($("#designer-spaces-help").empty(),this.designer().context()){case"system":document.getElementById("designer-spaces-type").innerHTML="Systems",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-system.html").source());break;case"schemas":document.getElementById("designer-spaces-type").innerHTML="Schemas",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-schemas.html").source());break;case"models":document.getElementById("designer-spaces-type").innerHTML="Models",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-models.html").source());break;case"types":document.getElementById("designer-spaces-type").innerHTML="Types",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-types.html").source());break;case"behaviors":document.getElementById("designer-spaces-type").innerHTML="Behaviors",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-behaviors.html").source());break;case"components":document.getElementById("designer-spaces-type").innerHTML="Components",document.getElementById("designer-spaces-help").insertAdjacentHTML("beforeend",this.require("help-components.html").source())}if($("#designer-spaces-items").empty(),c)switch(this.designer().context()){case"system":this.items().forEach(function(a){this.items().pop()}.bind(this));var h=JSON.parse(window.localStorage.getItem("systems")),i=[],j=0,k=0;for(h&&(i=h.systems),j=i.length,k=0;j>k;k++)c=JSON.parse(window.localStorage.getItem(i[k])),e=new d({name:c.name,uuid:c._id}),this.items().push(e);for(this.items().forEach(function(a){f.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+a.uuid()+"#system#"+a.name()+'">'+a.name()+"</a></li>")}),j=f.children.length,k=0;j>k;k++)b=f.children[k],b.addEventListener("click",function(){a(),$(this).addClass("active")}),b.addEventListener("click",function(){this.click()}.bind(g.items(k)));this.items().forEach(function(a){a.on("click",function(){var a=this.require("designer"),b=JSON.parse(window.localStorage.getItem(this.uuid())),c=this.require("System");b&&a.system(new c(b))})}),j>0&&($("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):this.require("designer").system()?$("#designer-space-"+this.require("designer").system().name()).length&&($("#designer-space-"+this.require("designer").system().name()).addClass("active"),this.require("designer").space(this.require("designer").system().name())):(b=f.children[0],$(b).addClass("active"),this.require("designer").space(this.items(0).name())));break;case"schemas":this.items().forEach(function(a){this.items().pop()}.bind(this));for(name in c.schemas())"undefined"==typeof c.schemas()[name]._schema&&(e=new d({name:name}),this.items().push(e));for(this.items().forEach(function(a){f.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+c.id()+"#schemas#"+a.name()+'">'+a.name()+"</a></li>")}),j=f.children.length,k=0;j>k;k++)b=f.children[k],b.addEventListener("click",function(){a(),$(this).addClass("active")}),b.addEventListener("click",function(){this.click()}.bind(g.items(k)));j>0?$("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(b=f.children[0],$(b).addClass("active"),this.require("designer").space(this.items(0).name())):this.require("designer").space("");break;case"models":this.items().forEach(function(a){this.items().pop()}.bind(this));for(name in c.models())"undefined"!=typeof c.models()[name]._schema&&(e=new d({name:name}),this.items().push(e));for(this.items().forEach(function(a){f.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+c.id()+"#models#"+a.name()+'">'+a.name()+"</a></li>")}),j=f.children.length,k=0;j>k;k++)b=f.children[k],b.addEventListener("click",function(){a(),$(this).addClass("active")}),b.addEventListener("click",function(){this.click()}.bind(g.items(k)));j>0?$("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(b=f.children[0],$(b).addClass("active"),this.require("designer").space(this.items(0).name())):this.require("designer").space("");break;case"types":this.items().forEach(function(a){this.items().pop()}.bind(this));for(name in c.types())e=new d({name:name}),this.items().push(e);for(this.items().forEach(function(a){f.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+c.id()+"#types#"+a.name()+'">'+a.name()+"</a></li>")}),j=f.children.length,k=0;j>k;k++)b=f.children[k],b.addEventListener("click",function(){a(),$(this).addClass("active")}),b.addEventListener("click",function(){this.click()}.bind(g.items(k)));j>0&&($("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(b=f.children[0],$(b).addClass("active"),this.require("designer").space(this.items(0).name())));break;case"behaviors":this.items().forEach(function(a){this.items().pop()}.bind(this)),e=new d({name:this.require("designer").system().name(),uuid:this.require("designer").system().id()}),this.items().push(e);for(name in c.models())"undefined"!=typeof c.models()[name]._schema&&(e=new d({name:name}),this.items().push(e));for(this.items().forEach(function(a){f.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+c.id()+"#behaviors#"+a.name()+'">'+a.name()+"</a></li>")}),j=f.children.length,k=0;j>k;k++)b=f.children[k],b.addEventListener("click",function(){a(),$(this).addClass("active")}),b.addEventListener("click",function(){this.click()}.bind(g.items(k)));j>0&&($("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(b=f.children[0],$(b).addClass("active"),this.require("designer").space(this.items(0).name())));break;case"components":this.items().forEach(function(a){this.items().pop()}.bind(this));for(name in c.models())"undefined"!=typeof c.models()[name]._schema&&(e=new d({name:name}),this.items().push(e));for(this.items().forEach(function(a){f.insertAdjacentHTML("beforeend",'<li id="designer-space-'+a.name()+'" class=""><a href="#'+c.id()+"#components#"+a.name()+'">'+a.name()+"</a></li>")}),j=f.children.length,k=0;j>k;k++)b=f.children[k],b.addEventListener("click",function(){a(),$(this).addClass("active")}),b.addEventListener("click",function(){this.click()}.bind(g.items(k)));j>0&&($("#designer-space-"+this.require("designer").space()).length?$("#designer-space-"+this.require("designer").space()).addClass("active"):(b=f.children[0],$(b).addClass("active"),this.require("designer").space(this.items(0).name())))}});var A=this.require("Workspace");A.on("init",function(a){var b=this;$("html").on("dragenter dragover",!1).on("drop",function(a){a.stopPropagation(),a.preventDefault();var c=a.originalEvent.dataTransfer.files,d=new FileReader,e="";d.onload=function(a){e+=a.target.result},d.onloadend=function(){var a=JSON.parse(e),c=b.require("DialogDropFile");c=new c({title:"A system has been found",message:"What do you want to do ?"}),c.data(a),c.show()},d.readAsText(c[0],"UTF-8")})}),A.on("create",function(){function a(){function a(){return Math.floor(65536*(1+Math.random())).toString(16)}return a()+a()+a()}var b=null,c=null,d=this.require("designer").system();switch(this.designer().context()){case"system":b=this.require("DialogSystemCreation"),c=new b({title:"Create a new system"}),c.show(),c.on("ok",function(){function a(){function a(){return Math.floor(65536*(1+Math.random())).toString(16)}return a()+a()+a()}var b=this.require("designer"),c=null,d="",e="",f={},g=this.require("System"),h=null,i=null;c=$("#designer-dialog-system-creation-name").val(),c=c.trim(),c=c.replace(/ /gi,"_"),c&&(d=a(),e=a(),f={name:c,master:!1,subsystem:!1,version:"0.0.1",description:"",schemas:{},behaviors:{},types:{},components:{},_id:d},f.behaviors[e]={_id:e,component:d,state:"main",action:"function main() { \n}",useCoreAPI:!1,core:!1},b.system()&&b.system().destroy(),b.system(new g(f)),h=this.require("ModelSystem"),i=new h({title:c}),i.uuid=d,i.document(JSON.parse(JSON.stringify(f))),i.content(JSON.stringify(f)),b.save(),this.hide(),b.space(c),b.spaces().render(),b.workspace().refresh(),this.require("message").success("system created. You can now begin to create schemas."))});break;case"schemas":d&&Object.keys(d).length&&(b=this.require("DialogSchemaCreation"),c=new b({title:"Create a new schema"}),c.show(),c.on("ok",function(){var a=this.require("designer"),b=null,c={},d=null,e=null;b=$("#designer-dialog-schema-creation-name").val(),b=b.trim(),b=b.replace(/ /gi,"_"),b&&(c={_name:b,_inherit:["RuntimeComponent"]},a.system().schemas()[b]=c,d=this.require("ModelSchema"),e=new d({title:b}),e.document(JSON.parse(JSON.stringify(c))),e.content(JSON.stringify(c)),a.save(),this.require("channel").createSchema(b,c),this.hide(),a.space(b),a.spaces().render(),a.workspace().refresh(),this.require("message").success("schema created. You can now edit it and generate models from this schema."))}));break;case"models":d&&Object.keys(d).length&&(b=this.require("DialogModelCreation"),c=new b({title:"Create a new model"}),c.show(),c.on("ok",function(){var a=this.require("designer"),b=null,c=null,d={},e=null,f=null;if(b=$("#designer-dialog-model-creation-name").val(),c=$("#designer-dialog-model-creation-schema").val(),b=b.trim(),b=b.replace(/ /gi,"_"),b&&c){d={_name:b,_schema:c,_inherit:["RuntimeComponent"]};for(var g in a.system().schemas()[c])switch(!0){case"property"===a.system().schemas()[c][g]:d[g]={type:"string",readOnly:!1,mandatory:!1,"default":""};break;case"link"===a.system().schemas()[c][g]:d[g]={type:"@RuntimeComponent",readOnly:!1,mandatory:!1,"default":{}};break;case"method"===a.system().schemas()[c][g]:d[g]={params:[{name:"param",type:"string",mandatory:!1}],result:"string"};break;case"event"===a.system().schemas()[c][g]:d[g]={params:[{name:"param",type:"string",mandatory:!1}]};break;case"collection"===a.system().schemas()[c][g]:d[g]={type:["string"],readOnly:!1,mandatory:!1,"default":[]}}a.system().models()[b]=d,e=this.require("ModelClass"),f=new e({title:b}),f.document(JSON.parse(JSON.stringify(d))),f.content(JSON.stringify(d)),a.save(),this.require("channel").createModel(b,d),this.hide(),a.space(b),a.spaces().render(),a.workspace().refresh(),this.require("message").success("model generated from the schema. You can now edit it, create behaviors or components from this model.")}}));break;case"types":d&&Object.keys(d).length&&(b=this.require("DialogTypeCreation"),c=new b({title:"Create a new type"}),c.show(),c.on("ok",function(){var a=this.require("designer"),b=null,c=!1,d={},e=null,f=null;b=$("#designer-dialog-type-creation-name").val(),c=$("#designer-dialog-type-creation-isEnum")[0].checked,b=b.trim(),b=b.replace(/ /gi,"_"),b&&(d=c?{name:b,type:"string",value:[""]}:{name:b,type:"object",schema:{}},a.system().types()[b]=d,e=this.require("ModelType"),f=new e({title:b}),f.uuid=b,f.document(JSON.parse(JSON.stringify(d))),f.content(JSON.stringify(d)),a.save(),this.require("channel").createType(b,d),this.hide(),a.space(b),a.spaces().render(),a.workspace().refresh(),this.require("message").success("type created. You can use it in your model."))}));break;case"components":if(d&&Object.keys(d).length){var e=this.require("designer"),f=e.system().schemas(),g=e.system().models(),h={},i=null,j=null,k="",l="";if(k=e.space()){l=a(),h={_id:l};var m=f[k]._schema,n=f[m],o=[];for(var p in n)"property"===n[p]&&o.push(p),"link"===n[p]&&o.push(p),"collection"===n[p]&&o.push(p);o.sort(),length=o.length;for(var q=0;q<length;q++)h[o[q]]=g[k][o[q]]["default"];e.system().components()[k]||(e.system().components()[k]={}),e.system().components()[k][l]=h,i=this.require("ModelComponent"),j=new i({title:l.toString()}),j.model(k),j.uuid(l.toString()),j.document(JSON.parse(JSON.stringify(h))),j.content(JSON.stringify(h)),j.render(),$("#designer-component-"+l.toString()).hide(),$("#designer-component-"+l.toString()).fadeIn(1e3),e.save(),this.require("channel").createComponent(k,h)}}break;case"behaviors":d&&Object.keys(d).length&&(b=this.require("DialogBehaviorCreation"),c=new b({title:"Create a new behavior"}),c.show(),c.on("ok",function(){function a(){function a(){return Math.floor(65536*(1+Math.random())).toString(16)}return a()+a()+a()}var b=this.require("designer"),c=b.system().schemas(),d=b.system().models(),e="",f=null,g={},h="",i="",j=null,k=null,l="",m="",n="",o="",p=0,q=0;if(l=b.space(),m=$("#designer-dialog-behavior-creation-state").val(),l&&m){if(n=a(),l!==b.system().name()){if(e=d[l]._schema,d[l][m]&&(f=d[l][m].params),f&&f.length)for(q=f.length,p=0;q>p;p++)o=0===p?f[p].name:o+", "+f[p].name;if("property"!==c[e][m]&&"link"!==c[e][m]||(o="value"),"collection"===c[e][m]&&(o="size, value, event"),"init"===m&&(o="conf"),d[l][m]&&(h=d[l][m].result),h)switch(h){case"string":i="	var result = '';\n	return result;\n";break;case"array":i="	var result = [];\n	return result;\n";break;case"number":i="	var result = 0;\n	return result;\n";break;case"object":i="	var result = {};\n	return result;\n";break;default:i="	var result = {};\n	return result;\n"}}else l=b.system().id();g={_id:n,component:l,state:m,action:"function "+m+"("+o+") {\n"+i+"}",useCoreAPI:!1,core:!1},b.system().behaviors()[n]=g,j=this.require("ModelBehavior"),k=new j({uuid:n}),k.title(m),k.content(JSON.parse(JSON.stringify(g.action))),this.hide(),k.render(),Prism.highlightAll(),$("#designer-behavior-"+n.toString()).hide(),$("#designer-behavior-"+n.toString()).fadeIn(1e3),b.save(),this.require("channel").createBehavior(g)}}))}}),A.on("refresh",function(){var a=null,b=null,c=null,d=null,e=null,f="",g="",h=null,i=null,j=null,k=null,l=null,m=null,n=null,o=this.designer().system(),p=this.designer().space();if(o){switch(this.clear(),this.designer().context()){case"system":var q=JSON.parse(window.localStorage.getItem("systems")),r=[],s=0,t=0;for(q&&(r=q.systems),s=r.length,t=0;s>t;t++)o=JSON.parse(window.localStorage.getItem(r[t])),o.name===p&&(a=this.require("ModelSystem"),e=new a({title:o.name}),e.uuid(o._id),e.document(JSON.parse(JSON.stringify(o))),e.content(JSON.stringify(o)),e.render());break;case"schemas":if(p)for(f in o.schemas())if(o.schemas()[f]._name===p){b=this.require("ModelSchema");var u=o.schemas()[f]._inherit,s=0;for(u&&(s=u.length),t=0;s>t;t++){if(d=new b({title:u[t]}),d.uuid(u[t]),"RuntimeComponent"===u[t]){var v={_name:"RuntimeComponent",_core:!0,classInfo:"property",on:"method",off:"method",require:"method",destroy:"method",init:"method",error:"event"};d.document(v),d.content(JSON.stringify(v))}else d.document(JSON.parse(JSON.stringify(o.schemas()[u[t]]))),d.content(JSON.stringify(o.schemas()[u[t]]));d.render()}for(d=new b({title:f}),d.uuid(f),d.document(JSON.parse(JSON.stringify(o.schemas()[f]))),d.content(JSON.stringify(o.schemas()[f])),d.render(),t=0;s>t;t++)this.designer().linkModel(f,u[t])}break;case"models":if(p)for(f in o.models())if(o.models()[f]._name===p){c=this.require("ModelClass");var u=o.models()[f]._inherit,s=0;for(u&&(s=u.length),t=0;s>t;t++){if(h=new c({title:u[t]}),h.uuid(u[t]),"RuntimeComponent"===u[t]){var w={_name:"RuntimeComponent",_schema:"RuntimeComponent",_core:!0,on:{params:[{name:"state",type:"string"},{name:"handler",type:"function"},{name:"useCoreAPI",type:"boolean",mandatory:!1}]},off:{params:[{name:"state",type:"string"},{name:"behaviorId",type:"string",mandatory:!1}]},require:{params:[{name:"id",type:"string"}]},destroy:{params:[]},classInfo:{type:"@RuntimeClassInfo",readOnly:!1,mandatory:!1,"default":{}},init:{params:[{name:"conf",type:"object"}]},error:{params:[{name:"data",type:"errorParam"}]}};h.document(w),h.content(JSON.stringify(w))}else h.document(JSON.parse(JSON.stringify(o.models()[u[t]]))),h.content(JSON.stringify(o.models()[u[t]]));h.render()}for(h=new c({title:f}),h.uuid(f),h.document(JSON.parse(JSON.stringify(o.models()[f]))),h.content(JSON.stringify(o.models()[f])),h.render(),t=0;s>t;t++)this.designer().linkModel(f,u[t])}break;case"types":if(p)for(f in o.types())o.types()[f].name===p&&(i=this.require("ModelType"),j=new i({title:f}),j.uuid(f),j.document(JSON.parse(JSON.stringify(o.types()[p]))),j.content(JSON.stringify(o.types()[p])),j.render());break;case"components":if(p)if(this.require("designer").state().component())f=this.require("designer").state().component(),o.components()[p][f]&&(k=this.require("ModelComponent"),l=new k({title:f}),l.uuid(f),l.model(p),l.document(JSON.parse(JSON.stringify(o.components()[p][f]))),l.content(JSON.stringify(o.components()[p][f])),l.render());else for(f in o.components()[p])k=this.require("ModelComponent"),l=new k({title:f}),l.uuid(f),l.model(p),l.document(JSON.parse(JSON.stringify(o.components()[p][f]))),l.content(JSON.stringify(o.components()[p][f])),l.render();break;case"behaviors":if(p){f=this.require("designer").state().component();for(g in o.behaviors())o.behaviors()[g].component===p&&(f&&o.behaviors()[g].state===f||""===f)&&(m=this.require("ModelBehavior"),n=new m({uuid:o.behaviors()[g]._id}),n.title(o.behaviors()[g].state),n.content(JSON.parse(JSON.stringify(o.behaviors()[g].action))),n.render()),p===this.require("designer").system().name()&&o.behaviors()[g].component===this.require("designer").system().id()&&(m=this.require("ModelBehavior"),n=new m({uuid:o.behaviors()[g]._id}),n.title(o.behaviors()[g].state),n.content(JSON.parse(JSON.stringify(o.behaviors()[g].action))),n.render());Prism.highlightAll()}}this.designer().filter()&&this.designer().filter(this.designer().filter())}}),A.on("clear",function(){$("#designer-workspace").empty()});var B=this.require("Server");B.on("start",function(){var a=null,b=null,c=null,d=null;a=this.require("RuntimeChannel"),b=new a({_id:"channel"}),b.on("send",function(a){this.require("worker").worker().port.postMessage(a)}),b.on("getSystem",function(a){var b=null;a===this.require("designer").system().id()?(b=this.require("db").collections().System.find({_id:a})[0],b=JSON.parse(JSON.stringify(b)),delete b.classInfo,this.setSystem(a,b)):this.setSystem(a,JSON.parse(window.localStorage.getItem(a)))}),b.on("getInitSystem",function(a){var b=null;a===this.require("designer").system().id()?(b=this.require("db").collections().System.find({_id:a})[0],b=JSON.parse(JSON.stringify(b)),delete b.classInfo,this.setInitSystem(a,b)):this.setInitSystem(a,JSON.parse(window.localStorage.getItem(a)))}),b.on("getType",function(a){this.setType(a,this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].types[a])}),b.on("getSchema",function(a){this.setSchema(a,this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].schemas[a])}),b.on("getModel",function(a){this.setModel(a,this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].models[a])}),b.on("getBehavior",function(a){this.setBehavior(a,this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].behaviors[a])}),b.on("getComponent",function(a,b){this.setComponent(a,b,this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].components[b][a],this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].models[b])}),b.on("updateType",function(a,b){var c=this.require("designer");c.system().types()[a]=b,c.save(),c.space(b.name),c.spaces().render(),c.workspace().refresh()}),b.on("deleteType",function(a){var b=this.require("designer"),c=[],d=null;c=this.require("db").collections().ModelType.find({uuid:a}),c.length&&(d=this.require(c[0]._id),d&&(d.hide(),d.destroy())),delete b.system().types()[a],b.save(),b.workspace().refresh()}),b.on("updateSchema",function(a,b){var c=this.require("designer");jsPlumb.deleteEveryEndpoint(),c.syncModel(b),c.system().schemas()[a]=b,c.save(),c.space(b._name),c.spaces().render(),c.workspace().refresh()}),b.on("deleteSchema",function(a){var b=this.require("designer"),c=[],d=null;c=this.require("db").collections().ModelSchema.find({uuid:a}),c.length&&(d=this.require(c[0]._id),d&&(d.hide(),d.destroy())),delete b.system().schemas()[a],b.save(),b.workspace().refresh()}),b.on("updateModel",function(a,b){var c=this.require("designer");jsPlumb.deleteEveryEndpoint(),c.system().models()[a]=b,c.save(),c.space(b._name),c.spaces().render(),c.workspace().refresh()}),b.on("deleteModel",function(a){var b=this.require("designer"),c=[],d=null;c=this.require("db").collections().ModelClass.find({uuid:a}),c.length&&(d=this.require(c[0]._id),d&&(d.hide(),d.destroy())),delete b.system().models()[a],b.save(),b.workspace().refresh()}),b.on("updateBehavior",function(a,b){var c=this.require("designer");c.system().behaviors()[a]=b,c.save(),c.workspace().refresh()}),b.on("deleteBehavior",function(a){var b=this.require("designer"),c=[],d=null;c=this.require("db").collections().ModelBehavior.find({uuid:a}),c.length&&(d=this.require(c[0]._id),d&&(d.hide(),d.destroy())),delete b.system().behaviors()[a],b.save(),b.workspace().refresh()}),b.on("updateComponent",function(a,b,c){var d=this.require("designer");d.system().components()[b][a]=c,d.save(),d.workspace().refresh()}),b.on("deleteComponent",function(a,b){var c=this.require("designer"),d=[],e=null;d=this.require("db").collections().ModelComponent.find({uuid:a}),d.length&&(e=this.require(d[0]._id),e&&(e.hide(),e.destroy())),delete c.system().components()[b][a],c.save(),c.workspace().refresh()}),b.on("updateSystem",function(a,b){var c=this.require("System"),d=null,e=this.require("designer");e.system()&&e.system().destroy(),d=new c(b),e.system(d),e.save(),e.space(b.name),e.spaces().render(),e.workspace().refresh()}),b.on("loadSystem",function(a){var b=null,c=null;b=this.require("DialogImport"),c=new b({title:"A system has been found",message:"Do you want to import the system ?",data:a}),c.show(),c.on("ok",function(){var a=this.require("System"),b=null,c=this.require("designer"),d=this.require("message");c.system()&&c.system().destroy(),b=new a(this.data()),c.system(b),c.save(),c.space(b.name()),c.spaces().render(),c.workspace().refresh(),this.hide(),c.save(),d.success("importation of the system is done.")})}),b.on("updateBehavior",function(a,b){var c=this.require("designer");c.debug()&&this.require(a).action(b.action)}),b.on("sync",function(){var a=null,b=null,c=this.require("designer");c.debug()&&(b=this.require("db").system(),c.system()&&c.system().destroy(),a=this.require("System"),c.system(new a(JSON.parse(b))),c.save(),c.space(c.system().name()),c.spaces().render(),c.workspace().refresh())}),c=this.require("Worker"),d=new c({_id:"worker",worker:new SharedWorker("./scripts/worker.js")}),d.worker().port.onmessage=function(a){$db.RuntimeMessage.insert(a.data)}},!0);var C=this.require("Designer");C.on("init",function(a){var b=null,c=null,d=null,e=null,f=null,g=null,h=null,i=null,j=null,k=null,l=null,m="",n=null,o=null;b=this.require("MenuBar"),c=new b({designer:this}),d=this.require("ToolBar"),e=new d({designer:this}),f=this.require("Workspace"),g=new f({designer:this}),j=this.require("Spaces"),k=new j({designer:this}),n=this.require("Server"),o=new n({designer:this}),this.menubar(c),this.toolbar(e),this.workspace(g),this.spaces(k),this.server(o),this.require("runtime").on("warning",function(a){this.require("message").warning(a)}),this.require("runtime").on("error",function(a){this.require("message").danger(a.message)}),h=this.require("DesignerState"),i=new h,this.state(i),l=this.require("System");var p=JSON.parse(window.localStorage.getItem("systems"));switch(!0){case"string"==typeof document.location.search.split("?")[1]:var q=JSON.parse(decodeURI(document.location.search.split("?")[1].split("system=")[1])),r=null;r=new l(q),this.system(r),this.save(),this.refresh(),this.require("message").success("the system '"+q.name+"' was imported");break;case window.location.href.split("#").length>1&&window.location.href.split("#")[1].length>0:m=window.location.href.split("#")[1],window.localStorage.getItem(m)&&(this.system(new l(JSON.parse(window.localStorage.getItem(m)))),this.refresh());break;default:p&&p.systems&&p.systems.length&&p.systems[0].length&&this.system(new l(JSON.parse(window.localStorage.getItem(p.systems[0])))),this.refresh()}this.check(),this.welcome();var s=this;window.onhashchange=function(a){var b=window.location.href.split("#"),c="",d="system",e="",f=0,g=0,h=null,i=null;for(b.length>1&&(c=b[1]),b.length>2&&(d=b[2]),b.length>3&&(e=b[3]),b.length>4?s.state().component(b[4]):s.state().component(""),b.length>1&&c?s.system(new l(JSON.parse(window.localStorage.getItem(c)))):p&&p.systems&&p.systems.length&&s.system(new l(JSON.parse(window.localStorage.getItem(p.systems[0])))),s.space(e),s.context(d),i=document.getElementById("designer-menubar-items"),g=s.menubar().items().length,f=0;g>f;f++)h=i.children[f],$(h).removeClass("active");for(f=0;g>f;f++)s.menubar().items(f).name()===d&&(h=i.children[f],$(h).addClass("active"));s.updateRouter()},$(window).resize(function(){jsPlumb.repaintEverything()})}),C.on("check",function(){var a=null,b=null;"undefined"==typeof SharedWorker&&(a=this.require("DialogCheck"),b=new a({title:"Hem... You will laugh",message:"Your browser has not all the features to use correctly System Designer.<br><br>Please use:<br><br>- Mozilla Firefox (recommended) or <br>- Google Chrome (desktop only).<br><br>"}),b.show())}),C.on("welcome",function(){var a=null,b=null;"undefined"!=typeof SharedWorker&&-1===document.cookie.indexOf("sysDesWelcome=true")&&(a=this.require("DialogWelcome"),b=new a({title:"Welcome to System Designer"}),b.show(),b.on("ok",function(){document.cookie="sysDesWelcome=true",this.hide()}))}),C.on("render",function(){this.menubar().render(),this.toolbar().render(),this.spaces().render()}),C.on("filter",function(a){var b=[],c="";switch(this.context()){case"behaviors":c="ModelBehavior";break;case"schemas":c="ModelSchema";break;case"types":c="ModelType";break;case"models":c="ModelClass";break;case"components":c="ModelComponent";break;case"system":c="ModelSystem"}for(var d=this.require("db").collections()[c].find({}),e=0;e<d.length;e++)b.push(this.require(d[e]._id));switch(a.length>0?b.forEach(function(b){-1===b.content().toLowerCase().indexOf(a.toLowerCase())?b.hide():b.show()}):b.forEach(function(a){a.show()}),this.context()){case"schemas":case"models":jsPlumb.repaintEverything()}}),C.on("context",function(a){jsPlumb.deleteEveryEndpoint(),this.spaces().render(),this.workspace().clear(),this.workspace().refresh()}),C.on("space",function(a){"system"===this.context()&&this.updateRouter()}),C.on("updateRouter",function(){var a=[],b=0,c=0,d="",e="";if(this.require("designer").system())for(a=$("#designer-menubar-items > li > a"),c=a.length,b=0;c>b;b++)e=a[b].href,d=e.split("#")[e.split("#").length-1],a[b].href="#"+this.require("designer").system().id()+"#"+d;else for(a=$("#designer-menubar-items > li > a"),c=a.length,b=0;c>b;b++)e=a[b].href,d=e.split("#")[e.split("#").length-1],a[b].href="##"+d}),C.on("syncModel",function(a){var b=(this.system().schemas(),this.system().models()),c="",d="",e=null,f=null,g=null,h=null;for(c in b)if(b.hasOwnProperty(c)&&"undefined"!=typeof b[c]._schema&&b[c]._schema===a._name){h=b[a._name],g=b[c];for(d in a)if(a.hasOwnProperty(d)&&0!==d.indexOf("_")&&("undefined"==typeof h[d]||h[d]!==a[d]))switch(!0){case"property"===a[d]:g[d]={type:"string",readOnly:!1,mandatory:!1,"default":""};for(e in this.system().components()[c])this.system().components()[c][e][d]=g[d]["default"];break;case"link"===a[d]:g[d]={type:"@RuntimeComponent",readOnly:!1,mandatory:!1,"default":{}};for(e in this.system().components()[c])this.system().components()[c][e][d]=g[d]["default"];break;case"method"===a[d]:g[d]={params:[{name:"param",type:"string",mandatory:!1}],result:"string"};for(e in this.system().components()[c])this.system().components()[c][e][d]=g[d]["default"];break;case"event"===a[d]:g[d]={params:[{name:"param",type:"string",mandatory:!1}]};for(e in this.system().components()[c])this.system().components()[c][e][d]=g[d]["default"];break;case"collection"===a[d]:g[d]={type:["string"],readOnly:!1,mandatory:!1,"default":[]};for(e in this.system().components()[c])this.system().components()[c][e][d]=g[d]["default"]}for(d in h)if(b[c].hasOwnProperty(d)&&0!==d.indexOf("_")&&"undefined"==typeof a[d]){delete b[c][d];for(e in this.system().components()[c])delete this.system().components()[c][e][d];for(f in this.system().behaviors())g&&this.system().behaviors()[f].component===g._name&&this.system().behaviors()[f].state===d&&delete this.system().behaviors()[f]}}}),C.on("linkModel",function(a,b){jsPlumb.setContainer("body"),jsPlumb.connect({paintStyle:{strokeStyle:"#7F949D",lineWidth:3},source:"designer-model-panel-"+a,target:"designer-model-panel-"+b,overlays:[["Arrow",{location:1}]]},{connector:["Flowchart"],anchor:["Left","Right"],endpoint:"Blank"})}),C.on("save",function(){var a=JSON.parse(window.localStorage.getItem("systems")),b=this.require("designer"),c=this.require("db").collections().System.find({_id:b.system().id()})[0],d=c._id;window.localStorage.setItem(d,JSON.stringify(c)),a?-1===a.systems.indexOf(d)&&a.systems.push(d):a={systems:[d]},window.localStorage.setItem("systems",JSON.stringify(a))}),a.on("main",function(){var a=null,b=null;a=this.require("Designer"),b=new a({_id:"designer"}),b.render(),b.server().start()}),a.main()});