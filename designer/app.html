<!DOCTYPE html>
<html>

<head>
    <title>App</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <!-- SyrupJS -->
    <script type="text/javascript" src="lib/system-runtime/system-runtime.min.js"></script>
    <script>
        syrup.on('ready', function () {
            var system = syrup.system('app');
            
            system.require('metamodel').schema({
                "_id": "SyrupChannelSchema",
                "_name": "SyrupChannelSchema",
                "_core": true,
                "getInitSystem": "event",
                "setInitSystem": "event"
            });

            system.require('metamodel').schema({
                "_id": "SyrupChannel",
                "_name": "SyrupChannel",
                "_schema": "SyrupChannelSchema",
                "_core": true,
                "getInitSystem": {
                    "params": [
                        {
                            "name": "id",
                            "type": "string"
                        }
                    ]
                },
                "setInitSystem": {
                    "params": [
                        {
                            "name": "id",
                            "type": "string"
                        },
                        {
                            "name": "system",
                            "type": "object"
                        }
                    ]
                }
            });            

            system.require('metamodel').create();

            system.on('main', function () {
                var Worker = null,
                    worker = null,
                    sysid = '';

                // Worker
                Worker = this.require('Worker');
                worker = new Worker({
                    '_core': true,
                    '_id': 'worker-run',
                    'worker': new SharedWorker('./scripts/worker.js'),
                });
                worker.worker().port.onmessage = function (e) {
                    $db.SyrupMessage.insert(e.data);
                }

                // Channel
                SyrupChannel = this.require('SyrupChannel');
                channel = new SyrupChannel({
                    '_core': true
                });
                channel.on('send', function (message) {
                    this.require('worker-run').worker().port.postMessage(message);
                });

                channel.on('setInitSystem', function (id, system) {
                    delete system.classInfo;
                    var systemID = this.require('db').system(system);

                    console.info('syrup: the system is loaded.')

                    this.require(systemID).main();
                });

                sysid = document.location.search.split('?')[1].split('id=')[1];
                channel.getInitSystem(sysid);
                
                console.info('syrup: loading the system...');
            }, true);
            
            system.main();
        });
    </script>
</body>

</html>