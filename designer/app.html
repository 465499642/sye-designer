<!DOCTYPE html>
<html>
<head>
    <title>App</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <!-- SyrupJS -->
    <script type="text/javascript" src="lib/system-runtime/system-runtime.min.js"></script>
    <script>
        syrup.on('ready', function () {
            var system = syrup.system('app');
            var metamodel = syrup.require('metamodel');

            // SYRUP ADMIN 
            metamodel.schema({
                "_id": "Worker",
                "_name": "Worker",
                "_schema": "WorkerSchema",
                "_inherit": [
                    "SyrupComponent"
                ],
                "_core": true,
                "worker": {
                    "type": "object",
                    "readOnly": false,
                    "mandatory": false,
                    "default": {}
                },
                "send": {
                    "params": [
                        {
                            "name": "message",
                            "type": "object"
                        }
                    ]
                }
            });

            metamodel.schema({
                "_id": "WorkerSchema",
                "_name": "WorkerSchema",
                "_inherit": [
                    "SyrupComponentSchema"
                ],
                "_core": true,
                "worker": "property",
                "send": "method"
            });

            metamodel.schema({
                "_id": "SyrupAdminSchema",
                "_name": "SyrupAdminSchema",
                "_inherit": [
                    "SyrupComponentSchema"
                ],
                "_core": true,
                "start": "method"
            });

            metamodel.schema({
                "_id": "SyrupAdmin",
                "_name": "SyrupAdmin",
                "_schema": "SyrupAdminSchema",
                "_inherit": [
                    "SyrupComponent"
                ],
                "_core": true,
                "start": {}
            });


            metamodel.schema({
                "_id": "SyrupChannelEventSchema",
                "_name": "SyrupChannelEventSchema",
                "_core": true,
                "getInitSystem": "event",
                "setInitSystem": "event"
            });


            metamodel.schema({
                "_id": "SyrupChannelEvent",
                "_name": "SyrupChannelEvent",
                "_schema": "SyrupChannelEventSchema",
                "_core": true,
                "getInitSystem": {
                    "params": [
                        {
                            "name": "id",
                            "type": "string"
                        }
                    ]
                },
                "setInitSystem": {
                    "params": [
                        {
                            "name": "id",
                            "type": "string"
                        },
                        {
                            "name": "system",
                            "type": "object"
                        }
                    ]
                }
            });            

            metamodel.create();

            // ADMIN
            var SyrupAdmin = syrup.require('SyrupAdmin');
            SyrupAdmin.on('start', function () {
                var Worker = null,
                        worker = null,
                        sysid = '';

                Worker = this.require('Worker');
                worker = new Worker({
                    "_id": "worker",
                    "worker": new SharedWorker('./scripts/worker.js'),
                });
                worker.worker().port.onmessage = function (e) {
                    $db.SyrupMessage.insert(e.data);
                }

                SyrupChannel = this.require('SyrupChannel');
                channel = new SyrupChannel({
                    '_id': 'channel'
                });

                channel.on('send', function (message) {
                    this.require('worker').worker().port.postMessage(message);
                });

                channel.on('setInitSystem', function (id, system) {
                    delete system.classInfo;
                    var systemID = this.require('db').system(system);

                    console.info('syrup: the system is loaded.')

                    syrup.require(systemID).main();
                });

                sysid = document.location.search.split('?')[1].split('id=')[1];
                channel.getInitSystem(sysid);
                console.info('syrup: loading the system...');
            }, true);

            //
            var admin = new SyrupAdmin();
            admin.start();
        });
    </script>
</body>

</html>