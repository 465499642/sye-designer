<!DOCTYPE html>
<html>

<head>
    <title>app</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="systems/app.json" type="application/json" rel="system">
</head>

<body>
    <!-- Runtime -->
    <script type="text/javascript" src="lib/system-runtime/system-runtime.min.js"></script>
    <script>
        runtime.on('ready', function () {
            var system = runtime.system('app');
            system.on('main', function () {
                var channel = null,
                    sysid = ''; 
                
                // start admin    
                this.require('admin').start('./');  
                              
                channel = this.require('channel-admin');
                
                // channel event
                channel.on('setInitSystem', function (id, system) {
                    delete system.classInfo;
                    var messages = [];
                    
                    // message queue
                    console.log = function (message) {
                        var date = new Date(),
                        time = date.toLocaleTimeString();
                        
                        messages.push({
                            'type': 'debug',
                            'log': '[' + time + '] ' + message
                        })
                    };   
                    
                    console.info = function (message) {
                        var date = new Date(),
                        time = date.toLocaleTimeString();
                        
                        messages.push({
                            'type': 'info',
                            'log': '[' + time + '] ' + message
                        })
                    };        
                    
                    console.warn = function (message) {
                        var date = new Date(),
                        time = date.toLocaleTimeString();
                        
                        messages.push({
                            'type': 'warn',
                            'log': '[' + time + '] ' + message
                        })
                    }; 
                    
                    console.error = function (message) {
                        var date = new Date(),
                        time = date.toLocaleTimeString();
                        
                        messages.push({
                            'type': 'error',
                            'log': '[' + time + '] ' + message
                        })
                    };                         
                    
                    this.require('logger').info('loading the system...');
                    var systemID = this.require('db').system(system);                  
                                        
                    // send messages
                    messages.forEach(function (message) {
                        this.logInfo(message);  
                    }.bind(this));
                    
                    console.log = function (message) {
                        var date = new Date(),
                        time = date.toLocaleTimeString();
                        
                        this.logDebug({
                            'type': 'debug',
                            'log': '[' + time + '] ' + message
                        });    
                    }.bind(this); 
                    
                    console.info = function (message) {
                        var date = new Date(),
                        time = date.toLocaleTimeString();
                        
                        this.logInfo({
                            'type': 'info',
                            'log': '[' + time + '] ' + message
                        });    
                    }.bind(this);  
                    
                    console.warn = function (message) {
                        var date = new Date(),
                        time = date.toLocaleTimeString();
                        
                        this.logWarn({
                            'type': 'warn',
                            'log': '[' + time + '] ' + message
                        });    
                    }.bind(this);  
                    
                    console.error = function (message) {
                        var date = new Date(),
                        time = date.toLocaleTimeString();
                        
                        this.logError({
                            'type': 'error',
                            'log': '[' + time + '] ' + message
                        });    
                    }.bind(this);     

                    this.require('logger').info('the system is loaded')
                    this.require(systemID).main();
                });

                sysid = document.location.search.split('?')[1].split('id=')[1];
                channel.getInitSystem(sysid);
                
                channel.off('sync');
                
                //this.require('logger').level('info');
            }, true);
            
            system.main();
        });
    </script>
</body>

</html>