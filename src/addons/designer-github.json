{"name":"designer-github","master":false,"subsystem":false,"version":"0.2.0","description":"","schemas":{"13bdf1ff1815d7c":{"_id":"13bdf1ff1815d7c","_name":"Github","_inherit":["RuntimeComponent"],"refresh":"method","push":"method"}},"models":{"1c23c1ed49186e9":{"_id":"1c23c1ed49186e9","_name":"Github","refresh":{},"push":{"params":[{"name":"comment","type":"string","mandatory":false,"default":""},{"name":"createHTML","type":"boolean","mandatory":false,"default":false},{"name":"createNode","type":"boolean","mandatory":false,"default":false},{"name":"logLevel","type":"string","mandatory":false,"default":"debug"},{"name":"createPackage","type":"boolean","mandatory":false,"default":false}]}}},"behaviors":{"1c2e3132fd18c75":{"_id":"1c2e3132fd18c75","component":"Github","state":"refresh","action":"function refresh() { \n  var config = {},\n      gh = null,\n      userName ='',\n      repository = '';\n\n  config = this.require('storage').get('system-designer-config');\n  if (config && config.githubToken && config.githubRepository) { \n\t\n\t  gh = new GitHub({\n      token: atob(config.githubToken)\n    });\n    \n    userName = config.githubRepository.split('/')[0];\n    repository = config.githubRepository.split('/')[1];\n    \n    repo = gh.getRepo(userName, repository);\n    \n    repo.getContents('master', '', 'raw')\n        .then(function (contents) {\n          contents.data.forEach(function (item) {\n            if (item.type === 'file' && item.name.indexOf('.json') !== -1) {\n              repo.getContents('master', item.name, 'raw')\n                  .then(function (content) {\n                    var system = content.data,\n                        systems = runtime.require('storage').get('system-designer-systems'),\n                        designer = runtime.require('designer'),\n                        System = runtime.require('System'),\n                        sys = null;\n                       \n                    // check valid system\n                    if (\n                        (Object.keys(system).indexOf('schemas') !== -1) && \n                        (Object.keys(system).indexOf('models') !== -1) &&\n                        (Object.keys(system).indexOf('behaviors') !== -1) &&\n                        (Object.keys(system).indexOf('types') !== -1) &&\n                        (Object.keys(system).indexOf('components') !== -1)\n                        ) {\n                        \n                      delete system.classInfo;\n                      \n                      if (runtime.require('storage').get(system._id)) {\n                        runtime.require('message').success('System ' + system.name  + ' updated.');\n                      } else {\n                        runtime.require('message').success('System ' + system.name  + ' created.');\n                      }\n                      \n                      // save system\n                      runtime.require('storage').set(system._id, system);\n              \n                      // save index\n                      if (!systems ) {\n                          systems = { 'systems': [system._id] };\n                      } else {\n                          if (systems.systems.indexOf(system._id) === -1) {\n                              systems.systems.push(system._id);\n                          }\n                      }\n                      runtime.require('storage').set('system-designer-systems', systems);\n                      \n                      // refresh\n                      if (!designer.system()) {\n                        sys = new System(system);\n                        designer.system(sys);\n                        designer.space(sys.name());\n                      }\n                      \n                      designer.spaces().render();\n                      designer.workspace().refresh();\n                      designer.updateRouter();\n                    }\n                  })\n                  .catch(function (e){\n                    runtime.require('message').danger('<strong>GitHub:</strong> ' + e.response.data.message + '.');\n                  });\n            }\n          });  \n          \n          if (contents.data.length === 0) {\n            runtime.require('message').info('there is no system in your repository.');\n          }\n        })\n        .catch(function (e) {\n          runtime.require('message').danger('<strong>GitHub:</strong> ' + e.response.data.message + '.');\n        });\n  } else {\n    runtime.require('message').warning('No configuration found for GitHub. Please update the configuration.');\n  }\n}","useCoreAPI":false,"core":false},"11845140101e5ae":{"_id":"11845140101e5ae","component":"Github","state":"push","action":"function push(comment, createHTML, createNode, logLevel, createPackage) { \n  var config = {},\n      gh = null,\n      userName ='',\n      repository = '',\n      designer = null,\n      system = {},\n      repo1 = null,\n      repo2 = null,\n      repo3 = null;\n\n  config = this.require('storage').get('system-designer-config');\n  if (config && config.githubToken && config.githubRepository) { \n\t\n\t  gh = new GitHub({\n      token: atob(config.githubToken)\n    });\n    \n    userName = config.githubRepository.split('/')[0];\n    repository = config.githubRepository.split('/')[1];\n    \n    designer = this.require('designer');\n    \n    if (designer.system()) {\n      system = this.require('db').collections().System.find({\n        '_id': designer.system().id()\n      })[0];\n      \n      system = JSON.parse(JSON.stringify(system));\n      delete system.classInfo;\n    \n      repo1 = gh.getRepo(userName, repository);\n      repo2 = gh.getRepo(userName, repository);\n      repo3 = gh.getRepo(userName, repository);\n      repo4 = gh.getRepo(userName, repository);\n      \n      repo1.writeFile('master', system.name + '.json', JSON.stringify(system), comment || 'updated with System Designer', {})\n          .then(function (response) {\n            var name = response.data.content.name.replace('.json', '');\n            var js = '';\n            var htmlSource = '';\n            var jsSource = '';\n            var packageSource = {};\n            \n            runtime.require('message').success('system ' + name + ' pushed on GitHub.');\n            \n            // HTML\n            if (createHTML) {\n              htmlSource = runtime.require('export-app-github.html').source();\n              htmlSource = htmlSource\n                .replace(/{{logLevel}}/g, logLevel)\n                .replace(/{{name}}/g, runtime.require('designer').system().name());\n              \n              repo2.writeFile('master', runtime.require('designer').system().name() + '.html', htmlSource, 'created with System Designer', {})\n              .then(function (response) {\n                var name = response.data.content.name;\n                runtime.require('message').success(name + ' created on GitHub.');\n              })\n              .catch(function (e) {\n                  runtime.require('message').danger('<strong>GitHub:</strong> ' + e.response.data.message + '.');\n              });   \n            }\n            \n            // Node\n            if (createNode) {\n              jsSource = decodeURIComponent(runtime.require('app-github.js').source());\n              jsSource = jsSource\n                .replace(/{{logLevel}}/g, logLevel)\n                .replace(/{{description}}/g, runtime.require('designer').system().description().replace(/\\n/g, '\\n * '))\n                .replace(/{{version}}/g, runtime.require('designer').system().version())\n                .replace(/{{name}}/g, runtime.require('designer').system().name());\n              \n              repo3.writeFile('master', runtime.require('designer').system().name() + '.js', jsSource, 'created with System Designer', {})\n              .then(function (response) {\n                var name = response.data.content.name;\n                runtime.require('message').success(name + ' created on GitHub.');\n              })\n              .catch(function (e) {\n                  runtime.require('message').danger('<strong>GitHub:</strong> ' + e.response.data.message + '.');\n              });   \n            }\n            \n            // PACKAGE\n            if (createPackage) {\n              packageSource.name = runtime.require('designer').system().name();\n              packageSource.version = runtime.require('designer').system().version();\n              packageSource.description = runtime.require('designer').system().description();\n              packageSource.main = './' + runtime.require('designer').system().name() + '.json';\n              packageSource.repository = {};\n              packageSource.repository.type = 'git';\n              packageSource.repository.url = 'https://github.com/' + config.githubRepository;\n              packageSource.dependencies = {};\n              packageSource.dependencies['system-runtime'] = '^1.9.7';\n              \n              repo4.writeFile('master', 'package.json', JSON.stringify(packageSource, null, '\\t').toString(), 'created with System Designer', {})\n              .then(function (response) {\n                var name = response.data.content.name;\n                runtime.require('message').success(name + ' created on GitHub.');\n              })\n              .catch(function (e) {\n                  runtime.require('message').danger('<strong>GitHub:</strong> ' + e.response.data.message + '.');\n              });   \n            }\n          })\n          .catch(function (e) {\n              runtime.require('message').danger('<strong>GitHub:</strong> ' + e.response.data.message + '.');\n          });\n    } else {\n      runtime.require('message').warning('There is no system to push on GitHub.');\n    }\n  } else {\n      runtime.require('message').warning('No configuration found for GitHub. Please update the configuration.');\n  }\n}","useCoreAPI":false,"core":false}},"types":{},"components":{"Github":{"github":{"_id":"github"}}},"_id":"1b9061a92113859"}