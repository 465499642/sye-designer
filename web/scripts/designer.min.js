/*
* System Designer
* http://systemdesigner.io
* @ecarriou
*
* Copyright (C) 2016 - Erwan Carriou
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
monoco.on("ready",function(){var a=this.system("design"),b=this.require("DialogImport");b.on("init",function(a){var b="",c=null;$("#monoco-dialog-import").empty(),b=this.require("dialog-modal-import.html"),document.querySelector("#monoco-dialog-import").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("monoco-dialog-import-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-import-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),b.on("show",function(){$("#monoco-dialog-import-modal").modal("show")}),b.on("hide",function(){$("#monoco-dialog-import-modal").modal("hide")});var c=this.require("DialogCheck");c.on("init",function(a){var b="";$("#monoco-dialog-check").empty(),b=this.require("dialog-modal-check.html"),document.querySelector("#monoco-dialog-check").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message()))}),c.on("show",function(){$("#monoco-dialog-check-modal").modal("show")}),c.on("hide",function(){$("#monoco-dialog-check-modal").modal("hide")});var d=this.require("DialogWelcome");d.on("init",function(a){var b="",c=null;$("#monoco-dialog-welcome").empty(),b=this.require("dialog-modal-welcome.html"),document.querySelector("#monoco-dialog-welcome").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("monoco-dialog-welcome-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),d.on("show",function(){$("#monoco-dialog-welcome-modal").modal("show")}),d.on("hide",function(){$("#monoco-dialog-welcome-modal").modal("hide")});var e=this.require("DialogExport");e.on("init",function(a){var b=null,c=null,d="";$("#monoco-dialog-export").empty(),d=this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0],b=this.require("dialog-modal-export.html"),document.querySelector("#monoco-dialog-export").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,window.location.toString().split("#")[0]+"?system="+encodeURI(JSON.stringify(d)))),c=document.getElementById("monoco-dialog-export-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-export-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),e.on("show",function(){$("#monoco-dialog-export-modal").modal("show")}),e.on("hide",function(){$("#monoco-dialog-export-modal").modal("hide")});var f=this.require("DialogCopyright");f.on("init",function(a){var b="",c=null;$("#monoco-dialog-copyright").empty(),b=this.require("dialog-modal-copyright.html"),document.querySelector("#monoco-dialog-copyright").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("monoco-dialog-copyright-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),f.on("show",function(){$("#monoco-dialog-copyright-modal").modal("show")}),f.on("hide",function(){$("#monoco-dialog-copyright-modal").modal("hide")});var g=this.require("DialogConfig");g.on("init",function(a){var b="",c=null,d=this,e=d.require("designer");$("#monoco-dialog-config").empty(),b=this.require("dialog-modal-config.html"),document.querySelector("#monoco-dialog-config").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),$("#monoco-dialog-type-config-isdebug")[0].checked=e.debug(),c=document.getElementById("monoco-dialog-config-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-config-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this)),c=document.getElementById("monoco-dialog-type-config-reset"),c.addEventListener("click",function(a){window.localStorage.clear(),this.require("designer").workspace().refresh(),this.require("message").success("system designer has been reseted.")}.bind(this)),c=document.getElementById("monoco-dialog-type-config-isdebug"),c.addEventListener("click",function(a){var b=d.require("designer"),c=!1;c=$("#monoco-dialog-type-config-isdebug")[0].checked,c?b.debug(!0):b.debug(!1)})}),g.on("show",function(){$("#monoco-dialog-config-modal").modal("show")}),g.on("hide",function(){$("#monoco-dialog-config-modal").modal("hide")});var h=this.require("DialogImportFile");h.on("init",function(a){var b="",c=null,d=this;d.require("designer");$("#monoco-dialog-import-file").empty(),b=this.require("dialog-modal-import-file.html"),document.querySelector("#monoco-dialog-import-file").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("monoco-dialog-import-file-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-import-file-modal-merge"),c.addEventListener("click",function(a){this.mergeSystem()}.bind(this)),c=document.getElementById("monoco-dialog-import-file-modal-import"),c.addEventListener("click",function(a){this.importSystem()}.bind(this)),c=document.getElementById("monoco-dialog-import-file-modal-file"),c.addEventListener("change",function(a){a.stopPropagation(),a.preventDefault();var b=a.target.files,c=new FileReader,d="",e=this;c.onload=function(a){d+=a.target.result},c.onloadend=function(){try{e.data(JSON.parse(d))}catch(a){e.data({})}},c.readAsText(b[0],"UTF-8")}.bind(this))}),h.on("show",function(){$("#monoco-dialog-import-file-modal").modal("show")}),h.on("hide",function(){$("#monoco-dialog-import-file-modal").modal("hide")});var i=this.require("DialogDropFile");i.on("init",function(a){var b=null,c=null;$("#monoco-dialog-drop-file").empty(),b=this.require("dialog-modal-drop-file.html"),document.querySelector("#monoco-dialog-drop-file").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{message}}/gi,this.message())),c=document.getElementById("monoco-dialog-drop-file-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-drop-file-modal-merge"),c.addEventListener("click",function(a){this.mergeSystem()}.bind(this)),c=document.getElementById("monoco-dialog-drop-file-modal-import"),c.addEventListener("click",function(a){this.importSystem()}.bind(this))}),i.on("mergeSystem",function(){var a=null,b="",c="",d=this.require("designer"),e=d.system(),f=this.require("message");a=this.data();for(b in a.schemas)e.schemas()[b]=a.schemas[b];for(b in a.types)e.types()[b]=a.types[b];for(b in a.behaviors)e.behaviors()[b]=a.behaviors[b];for(b in a.components){e.components()[b]||(e.components()[b]={});for(c in a.components[b])e.components()[b][c]=a.components[b][c]}d.save(),d.workspace().refresh(),this.hide(),d.save(),f.success("merge of the system is done.")}),i.on("importSystem",function(){var a=this.require("System"),b=null,c=this.require("designer"),d=this.require("message");c.system()&&c.system().destroy(),b=new a(this.data()),c.system(b),c.save(),c.workspace().refresh(),this.hide(),c.save(),d.success("importation of the system is done.")}),i.on("show",function(){$("#monoco-dialog-drop-file-modal").modal("show")}),i.on("hide",function(){$("#monoco-dialog-drop-file-modal").modal("hide")});var j=this.require("DialogTypeCreation");j.on("init",function(a){var b="",c=null;$("#monoco-dialog-type-creation").empty(),b=this.require("dialog-modal-type-creation.html"),document.querySelector("#monoco-dialog-type-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("monoco-dialog-type-creation-name"),c.addEventListener("keydown",function(a){return 13===a.keyCode?(a.stopPropagation(),a.preventDefault(),$("#monoco-dialog-type-creation-name").val()&&this.ok(),!1):void 0}.bind(this)),c=document.getElementById("monoco-dialog-type-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-type-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),j.on("show",function(){$("#monoco-dialog-type-creation-modal").modal("show")}),j.on("hide",function(){$("#monoco-dialog-type-creation-modal").modal("hide")});var k=this.require("DialogSchemaCreation");k.on("init",function(a){var b="",c=null;$("#monoco-dialog-schema-creation").empty(),b=this.require("dialog-modal-schema-creation.html"),document.querySelector("#monoco-dialog-schema-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("monoco-dialog-schema-creation-name"),c.addEventListener("keydown",function(a){return 13===a.keyCode?(a.stopPropagation(),a.preventDefault(),$("#monoco-dialog-schema-creation-name").val()&&this.ok(),!1):void 0}.bind(this)),c=document.getElementById("monoco-dialog-schema-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-schema-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),k.on("show",function(){$("#monoco-dialog-schema-creation-modal").modal("show")}),k.on("hide",function(){$("#monoco-dialog-schema-creation-modal").modal("hide")});var l=this.require("DialogSystemCreation");l.on("init",function(a){var b="",c=null;$("#monoco-dialog-system-creation").empty(),b=this.require("dialog-modal-system-creation.html"),document.querySelector("#monoco-dialog-system-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title())),c=document.getElementById("monoco-dialog-system-creation-name"),c.addEventListener("keydown",function(a){return 13===a.keyCode?(a.stopPropagation(),a.preventDefault(),$("#monoco-dialog-system-creation-name").val()&&this.ok(),!1):void 0}.bind(this)),c=document.getElementById("monoco-dialog-system-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-system-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),l.on("show",function(){$("#monoco-dialog-system-creation-modal").modal("show")}),l.on("hide",function(){$("#monoco-dialog-system-creation-modal").modal("hide")});var m=this.require("DialogModelCreation");m.on("init",function(a){var b="",c=null,d="",e=this.require("designer"),f=e.system().schemas();$("#monoco-dialog-model-creation").empty();for(name in f)f[name]._schema||(d=d+'<option value="'+name+'">'+name+"</option>");b=this.require("dialog-modal-model-creation.html"),document.querySelector("#monoco-dialog-model-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{schemas}}/gi,d)),c=document.getElementById("monoco-dialog-model-creation-name"),c.addEventListener("keydown",function(a){return 13===a.keyCode?(a.stopPropagation(),a.preventDefault(),$("#monoco-dialog-model-creation-name").val()&&this.ok(),!1):void 0}.bind(this)),c=document.getElementById("monoco-dialog-model-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-model-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),m.on("show",function(){$("#monoco-dialog-model-creation-modal").modal("show")}),m.on("hide",function(){$("#monoco-dialog-model-creation-modal").modal("hide")});var n=this.require("DialogBehaviorCreation");n.on("init",function(a){var b="",c=null,d="",e="",f=[],g=[],h=this,i=this.require("designer"),j=i.system().schemas();$("#monoco-dialog-behavior-creation").empty();for(name in j)j[name]._schema&&f.push({name:name,schema:j[name]._schema});if(f.sort(),f.forEach(function(a){d=d+'<option value="'+a.name+'">'+a.name+"</option>"}),f.length){g.push("init");for(name in i.system().schemas()[f[0].name])switch(i.system().schemas()[f[0].schema][name]){case"property":case"collection":case"event":case"method":g.push(name)}}g.sort(),g.forEach(function(a){e=e+'<option value="'+a+'">'+a+"</option>"}),b=this.require("dialog-modal-behavior-creation.html"),document.querySelector("#monoco-dialog-behavior-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{models}}/gi,d).replace(/{{states}}/gi,e)),c=document.getElementById("monoco-dialog-behavior-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-behavior-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this)),c=document.getElementById("monoco-dialog-behavior-creation-model"),c.addEventListener("change",function(a){var b="",c="",d="",e=[],f=h.require("designer"),g=f.system().schemas();b=this.value,c=g[b]._schema,$("#monoco-dialog-behavior-creation-state").empty();for(d in g[c])"method"===g[c][d]&&e.push(d);e.push("init"),e.sort(),e.forEach(function(a){document.querySelector("#monoco-dialog-behavior-creation-state").insertAdjacentHTML("afterbegin",'<option value="'+a+'">'+a+"</option>")})})}),n.on("show",function(){$("#monoco-dialog-behavior-creation-modal").modal("show")}),n.on("hide",function(){$("#monoco-dialog-behavior-creation-modal").modal("hide")});var o=this.require("DialogComponentCreation");o.on("init",function(a){var b="",c=null,d="",e=this.require("designer"),f=e.system().schemas();$("#monoco-dialog-component-creation").empty();for(name in f)f[name]._schema&&(d=d+'<option value="'+name+'">'+name+"</option>");b=this.require("dialog-modal-component-creation.html"),document.querySelector("#monoco-dialog-component-creation").insertAdjacentHTML("afterbegin",b.source().replace(/{{title}}/gi,this.title()).replace(/{{models}}/gi,d)),c=document.getElementById("monoco-dialog-component-creation-modal-cancel"),c.addEventListener("click",function(a){this.cancel()}.bind(this)),c=document.getElementById("monoco-dialog-component-creation-modal-ok"),c.addEventListener("click",function(a){this.ok()}.bind(this))}),o.on("show",function(){$("#monoco-dialog-component-creation-modal").modal("show")}),o.on("hide",function(){$("#monoco-dialog-component-creation-modal").modal("hide")});var p=this.require("ModelSystem");p.on("render",function(){var a=null,b=this;a=this.require("model-system.html"),document.querySelector("#monoco-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,this.uuid())),a=document.getElementsByClassName("monoco-model-system-open-"+this.uuid()),a[0].addEventListener("click",function(a){window.open("system.html?_id="+b.uuid())}),a=document.getElementsByClassName("monoco-model-system-design-"+this.uuid()),a[0].addEventListener("click",function(a){var b=this.require("designer"),c=JSON.parse(window.localStorage.getItem(this.uuid())),d=this.require("System"),e=this.require("message");c&&(b.system(new d(c)),e.success("the system '"+c.name+"' is ready to be designed."))}.bind(this)),a=document.getElementsByClassName("monoco-model-system-delete-"+this.uuid()),a[0].addEventListener("click",function(a){var b=JSON.parse(window.localStorage.getItem("systems")),c=this.require("designer"),d=this.require("System"),e=this.uuid(),f=this.require("message");window.localStorage.removeItem(e),b.systems.splice(b.systems.indexOf(e),1),window.localStorage.setItem("systems",JSON.stringify(b)),c.system().destroy(),b.systems.length&&c.system(new d(JSON.parse(window.localStorage.getItem(b.systems[0])))),$("#monoco-system-"+this.uuid()).remove(),this.destroy(),f.success("the system has been destroyed.")}.bind(this))}),p.on("hide",function(){$("#monoco-system-"+this.uuid()).hide()}),p.on("show",function(){$("#monoco-system-"+this.uuid()).show()});var q=this.require("ModelType");q.on("render",function(){var a=null,b=this;a=this.require("model-type.html"),document.querySelector("#monoco-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{id}}/gi,this.title())),a=document.getElementsByClassName("monoco-model-type-open-"+this.title()),a[0].addEventListener("click",function(a){window.open("type.html?_id="+b.title())}),a=document.getElementsByClassName("monoco-model-type-delete-"+this.title()),a[0].addEventListener("click",function(a){var b=this.require("designer");delete b.system().types()[this.title()],$("#monoco-type-"+this.title()).remove(),this.destroy(),b.save(),b.require("message").success("the type has been destroyed.")}.bind(this))}),q.on("hide",function(){$("#monoco-type-"+this.title()).hide()}),q.on("show",function(){$("#monoco-type-"+this.title()).show()});var r=this.require("ModelSchema");r.on("render",function(){var a=null,b=this;a=this.require("model-schema.html"),document.querySelector("#monoco-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{id}}/gi,this.title())),a=document.getElementsByClassName("monoco-model-schema-open-"+this.title()),a[0].addEventListener("click",function(a){window.open("schema.html?_id="+b.title())}),a=document.getElementsByClassName("monoco-model-schema-delete-"+this.title()),a[0].addEventListener("click",function(a){var b=this.require("designer");delete b.system().schemas()[this.title()],$("#monoco-schema-"+this.title()).remove(),this.destroy(),b.save(),b.require("message").success("the schema has been destroyed.")}.bind(this))}),r.on("hide",function(){$("#monoco-schema-"+this.title()).hide()}),r.on("show",function(){$("#monoco-schema-"+this.title()).show()});var s=this.require("ModelClass");s.on("render",function(){var a=null,b=this;a=this.require("model-class.html"),document.querySelector("#monoco-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{id}}/gi,this.title())),a=document.getElementsByClassName("monoco-model-class-open-"+this.title()),a[0].addEventListener("click",function(a){window.open("model.html?_id="+b.title())}),a=document.getElementsByClassName("monoco-model-class-delete-"+this.title()),a[0].addEventListener("click",function(a){var b=this.require("designer");delete b.system().schemas()[this.title()],$("#monoco-class-"+this.title()).remove(),this.destroy(),b.save(),b.require("message").success("the model has been destroyed.")}.bind(this))}),s.on("hide",function(){$("#monoco-class-"+this.title()).hide()}),s.on("show",function(){$("#monoco-class-"+this.title()).show()});var t=this.require("ModelBehavior");t.on("render",function(){var a="",b=null,c=null,d=this;a=this.require("model-behavior.html"),b=a.source().replace(/{{title}}/gi,this.title()),b=b.replace(/{{_id}}/gi,this.uuid()),document.querySelector("#monoco-workspace").insertAdjacentHTML("afterbegin",b),c=document.getElementsByClassName("monoco-model-behavior-open-"+this.title()),c[0].addEventListener("click",function(a){window.open("behavior.html?_id="+d.uuid())}),b=document.getElementsByClassName("monoco-model-behavior-delete-"+this.title()),b[0].addEventListener("click",function(a){var b=this.require("designer");delete b.system().behaviors()[this.uuid()],$("#monoco-behavior-"+this.uuid()).remove(),this.destroy(),b.save(),b.require("message").success("the behavior has been destroyed.")}.bind(this))}),t.on("hide",function(){$("#monoco-behavior-"+this.uuid()).hide()}),t.on("show",function(){$("#monoco-behavior-"+this.uuid()).show()});var u=this.require("ModelComponent");u.on("render",function(){var a=null,b=this;a=this.require("model-component.html"),document.querySelector("#monoco-workspace").insertAdjacentHTML("afterbegin",a.source().replace(/{{title}}/gi,this.title()).replace(/{{_id}}/gi,this.uuid())),a=document.getElementsByClassName("monoco-model-component-open-"+this.title()),a[0].addEventListener("click",function(a){window.open("component.html?_id="+encodeURI(b.title()))}),a=document.getElementsByClassName("monoco-model-component-delete-"+this.title()),a[0].addEventListener("click",function(a){var b=this.require("designer");delete b.system().components()[this.model()][this.uuid()],Object.keys(b.system().components()[this.model()])&&delete b.system().components()[this.model()],$("#monoco-component-"+this.uuid()).remove(),this.destroy(),b.save(),b.require("message").success("the component has been destroyed.")}.bind(this))}),u.on("hide",function(){$("#monoco-component-"+this.uuid()).hide()}),u.on("show",function(){$("#monoco-component-"+this.uuid()).show()});var v=this.require("MenuBar");v.on("init",function(a){var b=[],c=[],d=[],e=[],f=this;b=this.require("db").collections().MenuHeader.find({type:"designer"}),this.header(this.require(b[0]._id)),c=this.require("db").collections().MenuItem.find({type:"designer"}),c.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),c.forEach(function(a){var b=a._id;f.items().push(f.require(b))}),d=this.require("db").collections().MenuAction.find({type:"designer"}),e=this.require("db").collections().MenuSearch.find({type:"designer"}),d=d.concat(e),d.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),d.forEach(function(a){var b=a._id;f.actions().push(f.require(b))})}),v.on("render",function(){function a(){var a=0,b=0,c=null;for(a=f.children.length,b=0;a>b;b++)c=f.children[b],$(c).removeClass("active")}var b=0,c=0,d=null,e=document.getElementById("monoco-menubar-header"),f=document.getElementById("monoco-menubar-items"),g=document.getElementById("monoco-menubar-actions"),h=this;for(e.insertAdjacentHTML("afterbegin",this.header().html().source()),this.items().forEach(function(a){f.insertAdjacentHTML("beforeend","<li>"+a.html().source()+"</>")}),b=f.children.length,c=0;b>c;c++)d=f.children[c],d.addEventListener("click",function(){a(),$(this).addClass("active")}),d.addEventListener("click",function(){this.click()}.bind(h.items(c)));this.actions().forEach(function(a){g.insertAdjacentHTML("afterbegin","<li>"+a.html().source()+"</>")}),b>0&&(this.designer().context(this.items(0).name()),d=f.children[0],$(d).addClass("active"));var i=this;$("#monoco-menu-action-search").on("keyup",function(a){var b=$("#monoco-menu-action-search").val();i.designer().filter(b)})});var w=this.require("ToolBar");w.on("init",function(a){var b=[],c=this;b=this.require("db").collections().ToolBarItem.find({type:"designer"}),b.sort(function(a,b){return a.position>b.position?1:a.position<b.position?-1:0}),b.forEach(function(a){var b=a._id;c.items().push(c.require(b))})}),w.on("render",function(){var a=document.getElementById("monoco-toolbar-items"),b=0,c=0,d=null,e=this;for(this.items().forEach(function(b){a.insertAdjacentHTML("beforeend","<li>"+b.html().source()+"</>")}),c=a.children.length,b=0;c>b;b++)d=a.children[b],d.addEventListener("click",function(){this.click()}.bind(e.items(b)))});var x=this.require("Workspace");x.on("init",function(a){var b=this;$("html").on("dragenter dragover",!1).on("drop",function(a){a.stopPropagation(),a.preventDefault();var c=a.originalEvent.dataTransfer.files,d=new FileReader,e="";d.onload=function(a){e+=a.target.result},d.onloadend=function(){var a=JSON.parse(e),c=b.require("DialogDropFile");c=new c({title:"A system has been found",message:"What do you want to do ?"}),c.data(a),c.show()},d.readAsText(c[0],"UTF-8")})}),x.on("create",function(){var a=null,b=null,c=this.require("designer").system();switch(this.designer().context()){case"system":a=this.require("DialogSystemCreation"),b=new a({title:"Create a new system"}),b.show(),b.on("ok",function(){function a(){function a(){return Math.floor(65536*(1+Math.random())).toString(16)}return a()+a()+a()}var b=this.require("designer"),c=null,d="",e="",f={},g=this.require("System"),h=null,i=null,j=this.require("message");c=$("#monoco-dialog-system-creation-name").val(),d=a(),e=a(),f={name:c,master:!1,subsystem:!1,version:"0.0.1",description:"",schemas:{},behaviors:{},types:{},components:{},_id:d},f.behaviors[e]={_id:e,component:d,state:"main",action:"function main() { \n}",useCoreAPI:!1,core:!1},b.system()&&b.system().destroy(),b.system(new g(f)),h=this.require("ModelSystem"),i=new h({title:c}),i.uuid(d),this.hide(),i.render(),b.save(),j.success("the system '"+c+"' has been created.")});break;case"schemas":c&&Object.keys(c).length&&(a=this.require("DialogSchemaCreation"),b=new a({title:"Create a new schema"}),b.show(),b.on("ok",function(){var a=this.require("designer"),b=null,c={},d=null,e=null,f=this.require("message");b=$("#monoco-dialog-schema-creation-name").val(),c={_id:b,_name:b,_inherit:["MonocoComponentSchema"]},a.system().schemas()[b]=c,d=this.require("ModelSchema"),e=new d({title:b}),this.hide(),e.render(),a.save(),f.success("the schema '"+b+"' has been created.")}));break;case"models":c&&Object.keys(c).length&&(a=this.require("DialogModelCreation"),b=new a({title:"Create a new model"}),b.show(),b.on("ok",function(){var a=this.require("designer"),b=null,c=null,d={},e=null,f=null,g=this.require("message");b=$("#monoco-dialog-model-creation-name").val(),c=$("#monoco-dialog-model-creation-schema").val(),d={_id:b,_name:b,_schema:c,_inherit:["MonocoComponent"]};for(var h in a.system().schemas()[c])switch(!0){case"property"===a.system().schemas()[c][h]:d[h]={type:"string",readOnly:!1,mandatory:!1,"default":""};break;case"method"===a.system().schemas()[c][h]:d[h]={params:[{name:"param",type:"string",mandatory:!1}],result:"string"};break;case"event"===a.system().schemas()[c][h]:d[h]={params:[{name:"param",type:"string",mandatory:!1}]};break;case"collection"===a.system().schemas()[c][h]:d[h]={type:["string"],readOnly:!1,mandatory:!1,"default":[]}}a.system().schemas()[b]=d,e=this.require("ModelClass"),f=new e({title:b}),this.hide(),f.render(),a.save(),g.success("the model '"+b+"' has been created.")}));break;case"types":c&&Object.keys(c).length&&(a=this.require("DialogTypeCreation"),b=new a({title:"Create a new type"}),b.show(),b.on("ok",function(){var a=this.require("designer"),b=null,c=!1,d={},e=null,f=null,g=this.require("message");b=$("#monoco-dialog-type-creation-name").val(),c=$("#monoco-dialog-type-creation-isEnum")[0].checked,d=c?{name:b,type:"string",value:[""]}:{name:b,type:"object",schema:{}},a.system().types()[b]=d,e=this.require("ModelType"),f=new e({title:b}),this.hide(),f.render(),a.save(),g.success("the type '"+b+"' has been created.")}));break;case"components":c&&Object.keys(c).length&&(a=this.require("DialogComponentCreation"),b=new a({title:"Create a new component"}),b.show(),b.on("ok",function(){function a(){function a(){return Math.floor(65536*(1+Math.random())).toString(16)}return a()+a()+a()}var b=this.require("designer"),c=b.system().schemas(),d={},e=null,f=null,g="",h="",i=this.require("message");g=$("#monoco-dialog-component-creation-model").val(),h=a(),d={_id:h};var j=c[g]._schema,k=c[j],l=[];for(var m in k)"property"===k[m]&&l.push(m);l.sort(),length=l.length;for(var n=0;n<length;n++)d[l[n]]=c[g][l[n]]["default"];b.system().components()[g]||(b.system().components()[g]={}),b.system().components()[g][h]=d,e=this.require("ModelComponent"),f=new e({title:h.toString()+" ("+g+")"}),f.model(g),f.uuid(h.toString()),this.hide(),f.render(),b.save(),i.success("the component '"+h.toString()+" ("+g+")' has been created.")}));break;case"behaviors":c&&Object.keys(c).length&&(a=this.require("DialogBehaviorCreation"),b=new a({title:"Create a new behavior"}),b.show(),b.on("ok",function(){function a(){function a(){return Math.floor(65536*(1+Math.random())).toString(16)}return a()+a()+a()}var b=this.require("designer"),c=b.system().schemas(),d="",e=null,f={},g="",h="",i=null,j=null,k="",l="",m="",n="",o=0,p=0,q=this.require("message");if(k=$("#monoco-dialog-behavior-creation-model").val(),l=$("#monoco-dialog-behavior-creation-state").val(),m=a(),d=c[k]._schema,c[k][l]&&(e=c[k][l].params),e&&e.length)for(p=e.length,o=0;p>o;o++)n=0===o?e[o].name:n+", "+e[o].name;if("property"===c[d][l]&&(n="value"),"collection"===c[d][l]&&(n="size, value, event"),"init"===l&&(n="conf"),c[k][l]&&(g=c[k][l].result),g)switch(g){case"string":h="	var result = '';\n	return result;\n";break;case"array":h="	var result = [];\n	return result;\n";break;case"number":h="	var result = 0;\n	return result;\n";break;case"object":h="	var result = {};\n	return result;\n";break;default:h="	var result = {};\n	return result;\n"}f={_id:m,component:k,state:l,action:"function "+l+"("+n+") {\n"+h+"}",useCoreAPI:!1,core:!1},b.system().behaviors()[m]=f,i=this.require("ModelBehavior"),j=new i({uuid:m}),j.title(k+"."+l),this.hide(),j.render(),b.save(),q.success("the behavior '"+k+"."+l+"' has been created.")}))}}),x.on("refresh",function(){var a=null,b=null,c=null,d=null,e=null,f="",g=null,h=null,i=null,j="",k=null,l=null,m=null,n=null,o=this.designer().system();if(o){switch(this.clear(),this.designer().context()){case"system":var p=JSON.parse(window.localStorage.getItem("systems")),q=[],r=0,s=0;for(p&&(q=p.systems),r=q.length,s=0;r>s;s++)o=JSON.parse(window.localStorage.getItem(q[s])),a=this.require("ModelSystem"),e=new a({title:o.name}),e.uuid(o._id),e.render();break;case"schemas":for(f in o.schemas())"undefined"==typeof o.schemas()[f]._schema&&(b=this.require("ModelSchema"),d=new b({title:f}),d.render());break;case"models":for(f in o.schemas())"undefined"!=typeof o.schemas()[f]._schema&&(c=this.require("ModelClass"),g=new c({title:f}),g.render());break;case"types":for(f in o.types())h=this.require("ModelType"),i=new h({title:f}),i.render();break;case"components":for(j in o.components())for(f in o.components()[j])k=this.require("ModelComponent"),l=new k({title:f+" ("+j+")"}),l.uuid(f),l.model(j),l.render();break;case"behaviors":for(f in o.behaviors())m=this.require("ModelBehavior"),n=new m({uuid:o.behaviors()[f]._id}),n.title(o.behaviors()[f].component+"."+o.behaviors()[f].state),n.render()}this.designer().filter()&&this.designer().filter(this.designer().filter())}}),x.on("clear",function(){$("#monoco-workspace").empty()});var y=this.require("Server");y.on("start",function(){var a=null,b=null,c=null,d=null;a=this.require("MonocoChannel"),b=new a({_id:"channel"}),b.on("send",function(a){this.require("worker").worker().port.postMessage(a)}),b.on("getSystem",function(a){a===this.require("designer").system().id()?this.setSystem(a,this.require("db").collections().System.find({_id:a})[0]):this.setSystem(a,JSON.parse(window.localStorage.getItem(a)))}),b.on("getInitSystem",function(a){a===this.require("designer").system().id()?this.setInitSystem(a,this.require("db").collections().System.find({_id:a})[0]):this.setInitSystem(a,JSON.parse(window.localStorage.getItem(a)))}),b.on("getType",function(a){this.setType(a,this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].types[a])}),b.on("getSchema",function(a){this.setSchema(a,this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].schemas[a])}),b.on("getModel",function(a){this.setModel(a,this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].schemas[a])}),b.on("getBehavior",function(a){this.setBehavior(a,this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].behaviors[a])}),b.on("getComponent",function(a,b){this.setComponent(a,b,this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].components[b][a],this.require("db").collections().System.find({_id:this.require("designer").system().id()})[0].schemas[b])}),b.on("updateType",function(a,b){var c=this.require("designer");c.system().types()[a]=b,c.save()}),b.on("updateSchema",function(a,b){var c=this.require("designer");c.system().schemas()[a]=b,c.save()}),b.on("updateModel",function(a,b){var c=this.require("designer");c.system().schemas()[a]=b,c.save()}),b.on("updateBehavior",function(a,b){var c=this.require("designer");c.system().behaviors()[a]=b,c.save()}),b.on("updateComponent",function(a,b,c){var d=this.require("designer");d.system().components()[b][a]=c,
d.save()}),b.on("updateSystem",function(a,b){var c=this.require("System"),d=null,e=this.require("designer");e.system()&&e.system().destroy(),d=new c(b),e.system(d),e.save(),e.workspace().refresh()}),b.on("loadSystem",function(a){var b=null,c=null;b=this.require("DialogImport"),c=new b({title:"A system has been found",message:"Do you want to import the system ?",data:a}),c.show(),c.on("ok",function(){var a=this.require("System"),b=null,c=this.require("designer"),d=this.require("message");c.system()&&c.system().destroy(),b=new a(this.data()),c.system(b),c.save(),c.workspace().refresh(),this.hide(),c.save(),d.success("importation of the system is done.")})}),b.on("updateBehavior",function(a,b){var c=this.require("designer");c.debug()&&this.require(a).action(b.action)}),b.on("sync",function(){var a=null,b=null,c=this.require("designer");c.debug()&&(b=this.require("db").system(),c.system()&&c.system().destroy(),a=this.require("System"),c.system(new a(JSON.parse(b))),c.save(),c.workspace().refresh())}),c=this.require("Worker"),d=new c({_id:"worker",worker:new SharedWorker("./scripts/worker.js")}),d.worker().port.onmessage=function(a){$db.MonocoMessage.insert(a.data)}},!0);var z=this.require("Designer");z.on("init",function(a){var b=null,c=null,d=null,e=null,f=null,g=null,h=null,i=null,j=null;b=this.require("MenuBar"),c=new b({designer:this}),d=this.require("ToolBar"),e=new d({designer:this}),f=this.require("Workspace"),g=new f({designer:this}),i=this.require("Server"),j=new i({designer:this}),this.menubar(c),this.toolbar(e),this.workspace(g),this.server(j),this.require("monoco").on("warning",function(a){this.require("message").warning(a)}),this.require("monoco").on("error",function(a){this.require("message").danger(a.message)}),h=this.require("System");var k=JSON.parse(window.localStorage.getItem("systems"));if(document.location.search.split("?")[1]){var l=JSON.parse(decodeURI(document.location.search.split("?")[1].split("system=")[1])),m=null;m=new h(l),this.system(m),this.save(),this.refresh(),this.require("message").success("the system '"+l.name+"' was imported")}else k&&(this.system(new h(JSON.parse(window.localStorage.getItem(k.systems[0])))),this.refresh());this.check(),this.welcome()}),z.on("check",function(){var a=null,b=null;"undefined"==typeof SharedWorker&&(a=this.require("DialogCheck"),b=new a({title:"Hem... You will laugh",message:"Your browser has not all the features to use correctly System Designer.<br><br>Please use:<br><br>- Mozilla Firefox (recommended), <br>- Google Chrome, <br>- or Opera.<br><br>"}),b.show())}),z.on("welcome",function(){var a=null,b=null;"undefined"!=typeof SharedWorker&&-1===document.cookie.indexOf("sysDesWelcome=true")&&(a=this.require("DialogWelcome"),b=new a({title:"Welcome to System Designer"}),b.show(),b.on("ok",function(){document.cookie="sysDesWelcome=true",this.hide()}))}),z.on("render",function(){this.menubar().render(),this.toolbar().render()}),z.on("filter",function(a){var b=[],c="";switch(this.context()){case"behaviors":c="ModelBehavior";break;case"schemas":c="ModelSchema";break;case"types":c="ModelType";break;case"models":c="ModelClass";break;case"components":c="ModelComponent";break;case"system":c="ModelSystem"}for(var d=this.require("db").collections()[c].find({}),e=0;e<d.length;e++)b.push(this.require(d[e]._id));a.length>0?b.forEach(function(b){-1===b.title().toLowerCase().indexOf(a.toLowerCase())?b.hide():b.show()}):b.forEach(function(a){a.show()})}),z.on("context",function(a){this.workspace().clear(),this.workspace().refresh()}),z.on("save",function(){var a=JSON.parse(window.localStorage.getItem("systems")),b=this.require("designer"),c=this.require("db").collections().System.find({_id:b.system().id()})[0],d=c._id;window.localStorage.setItem(d,JSON.stringify(c)),a?-1===a.systems.indexOf(d)&&a.systems.push(d):a={systems:[d]},window.localStorage.setItem("systems",JSON.stringify(a))}),a.on("main",function(){var a=null,b=null;a=this.require("Designer"),b=new a({_id:"designer"}),b.render(),b.server().start()}),a.main()});